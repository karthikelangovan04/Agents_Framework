<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
html {
  font-family: ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.markmap-dark {
  background: #27272a;
  color: white;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js"></script><script>(()=>{setTimeout(()=>{const{markmap:S,mm:Q}=window,$=new S.Toolbar;$.attach(Q);const I=$.render();I.setAttribute("style","position:absolute;bottom:20px;right:20px"),document.body.append(I)})})()</script><script>((l,U,M,R)=>{const N=l();window.mm=N.Markmap.create("svg#mindmap",(U||N.deriveOptions)(R),M),window.matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.classList.add("markmap-dark")})(()=>window.markmap,null,{"content":"User Session Flow: Frontend &#x2192; Backend","children":[{"content":"1. Login and token storage (frontend)","children":[{"content":"1.1 Login page submits credentials","children":[{"content":"<pre data-lines=\"16,27\"><code class=\"language-ts\"><span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">`<span class=\"hljs-subst\">&#x24;{getApiUrl()}</span>/auth/login`</span>, {\n  <span class=\"hljs-attr\">method</span>: <span class=\"hljs-string\">&quot;POST&quot;</span>,\n  <span class=\"hljs-attr\">headers</span>: { <span class=\"hljs-string\">&quot;Content-Type&quot;</span>: <span class=\"hljs-string\">&quot;application/json&quot;</span> },\n  <span class=\"hljs-attr\">body</span>: <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>({ username, password }),\n});\n<span class=\"hljs-keyword\">const</span> data = <span class=\"hljs-keyword\">await</span> res.<span class=\"hljs-title function_\">json</span>().<span class=\"hljs-title function_\">catch</span>(<span class=\"hljs-function\">() =&gt;</span> ({}));\n<span class=\"hljs-keyword\">if</span> (!res.<span class=\"hljs-property\">ok</span>) <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(data.<span class=\"hljs-property\">detail</span> || <span class=\"hljs-string\">&quot;Login failed&quot;</span>);\n<span class=\"hljs-title function_\">login</span>(data.<span class=\"hljs-property\">access_token</span>, { <span class=\"hljs-attr\">user_id</span>: data.<span class=\"hljs-property\">user_id</span>, <span class=\"hljs-attr\">username</span>: data.<span class=\"hljs-property\">username</span> });\nrouter.<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-string\">&quot;/chat&quot;</span>);\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"16,27"}}],"payload":{"tag":"h3","lines":"10,11"}},{"content":"1.2 AuthContext stores token and user","children":[{"content":"<pre data-lines=\"34,45\"><code class=\"language-ts\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">login</span> = (<span class=\"hljs-params\"><span class=\"hljs-attr\">t</span>: <span class=\"hljs-built_in\">string</span>, <span class=\"hljs-attr\">u</span>: <span class=\"hljs-title class_\">UserInfo</span></span>) =&gt; {\n  auth.<span class=\"hljs-title function_\">setToken</span>(t);\n  auth.<span class=\"hljs-title function_\">setUser</span>(u);\n  <span class=\"hljs-title function_\">setToken</span>(t);\n  <span class=\"hljs-title function_\">setUser</span>(u);\n  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> <span class=\"hljs-variable language_\">document</span> !== <span class=\"hljs-string\">&quot;undefined&quot;</span>) {\n    <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">cookie</span> = <span class=\"hljs-string\">`copilot_adk_user_id=<span class=\"hljs-subst\">&#x24;{u.user_id}</span>; path=/; max-age=<span class=\"hljs-subst\">&#x24;{<span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">7</span>}</span>; samesite=lax`</span>;\n  }\n};\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"34,45"}}],"payload":{"tag":"h3","lines":"28,29"}},{"content":"1.3 Persistence in localStorage","children":[{"content":"<strong>File</strong>: <code>frontend/lib/auth.ts</code>","children":[],"payload":{"tag":"li","lines":"48,49"}},{"content":"<strong>What it does</strong>: Token stored under <code>copilot_adk_token</code>, user under <code>copilot_adk_user</code> (JSON: <code>user_id</code>, <code>username</code>). Used for initial load and for REST API calls (Bearer token).","children":[],"payload":{"tag":"li","lines":"49,50"}},{"content":"<strong>Keys</strong>: <code>TOKEN_KEY = &quot;copilot_adk_token&quot;</code>, <code>USER_KEY = &quot;copilot_adk_user&quot;</code>.","children":[],"payload":{"tag":"li","lines":"50,52"}}],"payload":{"tag":"h3","lines":"46,47"}}],"payload":{"tag":"h2","lines":"8,9"}},{"content":"2. Session list and create (REST API with JWT)","children":[{"content":"2.1 Chat page loads sessions","children":[{"content":"<pre data-lines=\"62,76\"><code class=\"language-ts\"><span class=\"hljs-keyword\">let</span> list = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">listSessions</span>(token);\n<span class=\"hljs-keyword\">if</span> (list.<span class=\"hljs-property\">length</span> === <span class=\"hljs-number\">0</span>) {\n  <span class=\"hljs-keyword\">const</span> newSession = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">createSession</span>(token);\n  list = [newSession];\n}\n<span class=\"hljs-title function_\">setSessions</span>(list);\n<span class=\"hljs-keyword\">if</span> (list.<span class=\"hljs-property\">length</span> &gt; <span class=\"hljs-number\">0</span>) {\n  <span class=\"hljs-keyword\">const</span> first = list[<span class=\"hljs-number\">0</span>];\n  <span class=\"hljs-title function_\">setCurrentSessionId</span>(first.<span class=\"hljs-property\">id</span>);\n  <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">cookie</span> = <span class=\"hljs-string\">`copilot_adk_session_id=<span class=\"hljs-subst\">&#x24;{first.id}</span>; path=/; ...`</span>;\n  <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">setUserAndSessionCookies</span>(user.<span class=\"hljs-property\">user_id</span>, first.<span class=\"hljs-property\">id</span>).<span class=\"hljs-title function_\">catch</span>(<span class=\"hljs-function\">() =&gt;</span> {});\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"62,76"}}],"payload":{"tag":"h3","lines":"56,57"}},{"content":"2.2 listSessions and createSession (frontend API client)","children":[{"content":"<pre data-lines=\"83,90\"><code class=\"language-ts\"><span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">`<span class=\"hljs-subst\">&#x24;{getApiUrl()}</span>/api/sessions`</span>, {\n  <span class=\"hljs-attr\">headers</span>: { <span class=\"hljs-title class_\">Authorization</span>: <span class=\"hljs-string\">`Bearer <span class=\"hljs-subst\">&#x24;{token}</span>`</span> },\n});\n<span class=\"hljs-keyword\">const</span> data = <span class=\"hljs-keyword\">await</span> res.<span class=\"hljs-title function_\">json</span>();\n<span class=\"hljs-keyword\">return</span> (data.<span class=\"hljs-property\">sessions</span> || []).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">s</span>) =&gt;</span> ({ <span class=\"hljs-attr\">id</span>: s.<span class=\"hljs-property\">id</span>, ... }));\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"83,90"}}],"payload":{"tag":"h3","lines":"77,78"}},{"content":"2.3 Backend: get current user from JWT and list/create sessions","children":[{"content":"<pre data-lines=\"97,107\"><code class=\"language-py\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_current_user_id</span>(<span class=\"hljs-params\">authorization, x_user_id</span>):\n    <span class=\"hljs-keyword\">if</span> x_user_id:\n        <span class=\"hljs-keyword\">return</span> x_user_id\n    token = authorization.split(<span class=\"hljs-string\">&quot; &quot;</span>, <span class=\"hljs-number\">1</span>)[<span class=\"hljs-number\">1</span>]\n    user_id = decode_access_token(token)\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> user_id:\n        <span class=\"hljs-keyword\">raise</span> HTTPException(status_code=<span class=\"hljs-number\">401</span>, detail=<span class=\"hljs-string\">&quot;Invalid or expired token&quot;</span>)\n    <span class=\"hljs-keyword\">return</span> user_id\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"97,107"}},{"content":"<pre data-lines=\"110,121\"><code class=\"language-py\">initial_state = {\n    <span class=\"hljs-string\">&quot;_ag_ui_user_id&quot;</span>: user_id,\n    <span class=\"hljs-string\">&quot;_ag_ui_app_name&quot;</span>: APP_NAME,\n    <span class=\"hljs-string\">&quot;_ag_ui_thread_id&quot;</span>: session_id,\n    <span class=\"hljs-string\">&quot;_ag_ui_session_id&quot;</span>: session_id,\n}\nsession = <span class=\"hljs-keyword\">await</span> session_service.create_session(\n    app_name=APP_NAME, user_id=user_id, session_id=session_id, state=initial_state\n)\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"110,121"}}],"payload":{"tag":"h3","lines":"91,92"}}],"payload":{"tag":"h2","lines":"54,55"}},{"content":"3. Cookies for AG-UI (user_id and session_id)","children":[{"content":"3.1 Where cookies are set","children":[{"content":"<strong>User cookie</strong>: Set in <code>AuthContext</code> on login and on restore; and in <code>chat/page.tsx</code> when <code>user</code> is available. Name: <code>copilot_adk_user_id</code>, value: numeric user id.","children":[],"payload":{"tag":"li","lines":"128,129"}},{"content":"<strong>Session cookie</strong>: Set in <code>chat/page.tsx</code> whenever <code>currentSessionId</code> changes (initial load, new chat, or selecting another session). Name: <code>copilot_adk_session_id</code>, value: UUID session id.","children":[],"payload":{"tag":"li","lines":"129,131"}}],"payload":{"tag":"h3","lines":"126,127"}},{"content":"3.2 Next.js API route that can set cookies (optional backup)","children":[{"content":"<pre data-lines=\"137,145\"><code class=\"language-ts\"><span class=\"hljs-keyword\">if</span> (userId) {\n  res.<span class=\"hljs-property\">cookies</span>.<span class=\"hljs-title function_\">set</span>(<span class=\"hljs-string\">&quot;copilot_adk_user_id&quot;</span>, <span class=\"hljs-title class_\">String</span>(userId), { <span class=\"hljs-attr\">path</span>: <span class=\"hljs-string\">&quot;/&quot;</span>, <span class=\"hljs-attr\">maxAge</span>: <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">7</span>, <span class=\"hljs-attr\">sameSite</span>: <span class=\"hljs-string\">&quot;lax&quot;</span> });\n}\n<span class=\"hljs-keyword\">if</span> (sessionId) {\n  res.<span class=\"hljs-property\">cookies</span>.<span class=\"hljs-title function_\">set</span>(<span class=\"hljs-string\">&quot;copilot_adk_session_id&quot;</span>, sessionId, { <span class=\"hljs-attr\">path</span>: <span class=\"hljs-string\">&quot;/&quot;</span>, <span class=\"hljs-attr\">maxAge</span>: <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">7</span>, <span class=\"hljs-attr\">sameSite</span>: <span class=\"hljs-string\">&quot;lax&quot;</span> });\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"137,145"}}],"payload":{"tag":"h3","lines":"131,132"}},{"content":"3.3 setUserAndSessionCookies (frontend)","children":[{"content":"<pre data-lines=\"152,161\"><code class=\"language-ts\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">setUserAndSessionCookies</span>(<span class=\"hljs-params\"><span class=\"hljs-attr\">userId</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">sessionId</span>: <span class=\"hljs-built_in\">string</span></span>): <span class=\"hljs-title class_\">Promise</span>&lt;<span class=\"hljs-built_in\">void</span>&gt; {\n  <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">&quot;/api/session&quot;</span>, {\n    <span class=\"hljs-attr\">method</span>: <span class=\"hljs-string\">&quot;POST&quot;</span>,\n    <span class=\"hljs-attr\">headers</span>: { <span class=\"hljs-string\">&quot;Content-Type&quot;</span>: <span class=\"hljs-string\">&quot;application/json&quot;</span> },\n    <span class=\"hljs-attr\">body</span>: <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>({ <span class=\"hljs-attr\">user_id</span>: userId, <span class=\"hljs-attr\">session_id</span>: sessionId }),\n  });\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"152,161"}}],"payload":{"tag":"h3","lines":"146,147"}}],"payload":{"tag":"h2","lines":"124,125"}},{"content":"4. CopilotKit &#x2192; Next.js proxy &#x2192; Backend /ag-ui","children":[{"content":"4.1 CopilotKit component (chat page)","children":[{"content":"<pre data-lines=\"172,180\"><code class=\"language-tsx\">&lt;<span class=\"hljs-title class_\">CopilotKit</span>\n  key={currentSessionId}\n  threadId={currentSessionId || <span class=\"hljs-literal\">undefined</span>}\n  runtimeUrl=<span class=\"hljs-string\">&quot;/api/copilotkit&quot;</span>\n  agent=<span class=\"hljs-string\">&quot;my_agent&quot;</span>\n&gt;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"172,180"}}],"payload":{"tag":"h3","lines":"166,167"}},{"content":"4.2 Next.js CopilotKit API route (proxy)","children":[{"content":"<pre data-lines=\"187,203\"><code class=\"language-ts\"><span class=\"hljs-keyword\">const</span> userId = req.<span class=\"hljs-property\">cookies</span>.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&quot;copilot_adk_user_id&quot;</span>)?.<span class=\"hljs-property\">value</span> || <span class=\"hljs-string\">&quot;default&quot;</span>;\n<span class=\"hljs-keyword\">const</span> sessionId = req.<span class=\"hljs-property\">cookies</span>.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&quot;copilot_adk_session_id&quot;</span>)?.<span class=\"hljs-property\">value</span> || <span class=\"hljs-string\">&quot;default&quot;</span>;\n\n<span class=\"hljs-keyword\">const</span> runtime = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">CopilotRuntime</span>({\n  <span class=\"hljs-attr\">agents</span>: {\n    <span class=\"hljs-attr\">my_agent</span>: <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">HttpAgent</span>({\n      <span class=\"hljs-attr\">url</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">&#x24;{backendUrl}</span>/ag-ui`</span>,\n      <span class=\"hljs-attr\">headers</span>: {\n        <span class=\"hljs-string\">&quot;X-User-Id&quot;</span>: userId,\n        <span class=\"hljs-string\">&quot;X-Session-Id&quot;</span>: sessionId,\n      },\n    }),\n  },\n});\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"187,203"}}],"payload":{"tag":"h3","lines":"181,182"}}],"payload":{"tag":"h2","lines":"164,165"}},{"content":"5. AG-UI protocol on the backend (deep dive)","children":[{"content":"5.1 Request hits /ag-ui with headers","children":[{"content":"<strong>File</strong>: <code>backend/main.py</code>","children":[],"payload":{"tag":"li","lines":"210,211"}},{"content":"<strong>What it does</strong>: Middleware logs <code>X-User-Id</code> and <code>X-Session-Id</code> for <code>/ag-ui</code>. The <code>ag-ui-adk</code> library handles the POST body (AG-UI protocol); before running the agent it calls <code>extract_state_from_request(request, input_data)</code> to merge request context into the run state.","children":[],"payload":{"tag":"li","lines":"211,212"}},{"content":"<strong>Flow</strong>: Incoming request has headers set by Next.js from cookies &#x2192; AG-UI handler runs &#x2192; state extractor runs first.","children":[],"payload":{"tag":"li","lines":"212,214"}}],"payload":{"tag":"h3","lines":"208,209"}},{"content":"5.2 extract_state_from_request (header &#x2192; state)","children":[{"content":"<pre data-lines=\"220,231\"><code class=\"language-py\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">extract_user_and_session</span>(<span class=\"hljs-params\">request: Request, input_data: RunAgentInput</span>) -&gt; <span class=\"hljs-built_in\">dict</span>[<span class=\"hljs-built_in\">str</span>, <span class=\"hljs-type\">Any</span>]:\n    state = {}\n    user_id = request.headers.get(<span class=\"hljs-string\">&quot;X-User-Id&quot;</span>)\n    session_id = request.headers.get(<span class=\"hljs-string\">&quot;X-Session-Id&quot;</span>)\n    <span class=\"hljs-keyword\">if</span> user_id:\n        state[<span class=\"hljs-string\">&quot;_ag_ui_user_id&quot;</span>] = user_id\n    <span class=\"hljs-keyword\">if</span> session_id:\n        state[<span class=\"hljs-string\">&quot;_ag_ui_session_id&quot;</span>] = session_id\n    <span class=\"hljs-keyword\">return</span> state\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"220,231"}}],"payload":{"tag":"h3","lines":"214,215"}},{"content":"5.3 user_id_extractor (state &#x2192; ADK user id)","children":[{"content":"<pre data-lines=\"238,246\"><code class=\"language-py\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">extract_user_from_state</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">input</span>: RunAgentInput</span>) -&gt; <span class=\"hljs-built_in\">str</span>:\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">isinstance</span>(<span class=\"hljs-built_in\">input</span>.state, <span class=\"hljs-built_in\">dict</span>):\n        user_id = <span class=\"hljs-built_in\">input</span>.state.get(<span class=\"hljs-string\">&quot;_ag_ui_user_id&quot;</span>)\n        <span class=\"hljs-keyword\">if</span> user_id:\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">str</span>(user_id)\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">f&quot;thread_user_<span class=\"hljs-subst\">{<span class=\"hljs-built_in\">input</span>.thread_id}</span>&quot;</span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"238,246"}}],"payload":{"tag":"h3","lines":"232,233"}},{"content":"5.4 ADKAgent and session service","children":[{"content":"<pre data-lines=\"253,257\"><code class=\"language-py\">session_service = DatabaseSessionService(db_url=DATABASE_URL)\nagent = LlmAgent(name=<span class=\"hljs-string\">&quot;assistant&quot;</span>, model=GEMINI_MODEL, ...)\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"253,257"}}],"payload":{"tag":"h3","lines":"247,248"}},{"content":"5.5 How AG-UI protocol uses session_id and thread_id","children":[{"content":"<strong>thread_id</strong>: In CopilotKit, <code>threadId</code> is set to <code>currentSessionId</code> (the UUID). The AG-UI client sends this in the protocol; the backend uses it to load/save the correct conversation.","children":[],"payload":{"tag":"li","lines":"260,261"}},{"content":"<strong>session_id</strong>: Same UUID is sent as <code>X-Session-Id</code> and stored in state as <code>_ag_ui_session_id</code>. The ADK session service keys storage by (app_name, user_id, session_id). So thread_id and session_id are the same value in this app.","children":[],"payload":{"tag":"li","lines":"261,262"}},{"content":"<strong>Session lifecycle</strong>: (1) Frontend creates session via <code>POST /api/sessions</code> &#x2192; backend creates row in Postgres with initial state including <code>_ag_ui_user_id</code>, <code>_ag_ui_thread_id</code>, <code>_ag_ui_session_id</code>. (2) User sends message &#x2192; CopilotKit calls <code>/api/copilotkit</code> with cookies &#x2192; Next.js adds <code>X-User-Id</code>, <code>X-Session-Id</code> &#x2192; backend merges into state &#x2192; user_id_extractor returns authenticated user id &#x2192; session service loads/updates session for that (user_id, session_id). So one session = one thread = one conversation in the DB.","children":[],"payload":{"tag":"li","lines":"262,264"}}],"payload":{"tag":"h3","lines":"258,259"}}],"payload":{"tag":"h2","lines":"206,207"}},{"content":"6. Session history (loading previous messages)","children":[{"content":"6.1 Frontend: getSessionHistory","children":[{"content":"<pre data-lines=\"274,286\"><code class=\"language-ts\"><span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">`<span class=\"hljs-subst\">&#x24;{getApiUrl()}</span>/agents/state`</span>, {\n  <span class=\"hljs-attr\">method</span>: <span class=\"hljs-string\">&quot;POST&quot;</span>,\n  <span class=\"hljs-attr\">headers</span>: { <span class=\"hljs-string\">&quot;Content-Type&quot;</span>: <span class=\"hljs-string\">&quot;application/json&quot;</span> },\n  <span class=\"hljs-attr\">body</span>: <span class=\"hljs-title class_\">JSON</span>.<span class=\"hljs-title function_\">stringify</span>({\n    <span class=\"hljs-attr\">threadId</span>: sessionId,\n    <span class=\"hljs-attr\">appName</span>: <span class=\"hljs-string\">&quot;copilot_adk_app&quot;</span>,\n    <span class=\"hljs-attr\">userId</span>: <span class=\"hljs-title class_\">String</span>(userId),\n  }),\n});\n<span class=\"hljs-comment\">// data.threadExists, data.messages, data.state</span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"274,286"}}],"payload":{"tag":"h3","lines":"268,269"}},{"content":"6.2 Backend /agents/state","children":[{"content":"<strong>Provided by</strong>: <code>ag-ui-adk</code> when you use <code>add_adk_fastapi_endpoint</code>. Not defined in app code.","children":[],"payload":{"tag":"li","lines":"289,290"}},{"content":"<strong>What it does</strong>: Accepts AG-UI state request (threadId, appName, userId), uses the same <code>session_service</code> to load the session from Postgres, returns existing state and message history so the frontend can show &#x201c;previous conversation&#x201d; and the agent can continue in the same thread.","children":[],"payload":{"tag":"li","lines":"290,292"}}],"payload":{"tag":"h3","lines":"287,288"}}],"payload":{"tag":"h2","lines":"266,267"}},{"content":"7. End-to-end flow summary","children":[{"content":"<strong>Login</strong>: <code>login/page.tsx</code> &#x2192; POST <code>/auth/login</code> &#x2192; backend returns JWT + user_id &#x2192; <code>AuthContext.login()</code> &#x2192; localStorage (token, user) + cookie <code>copilot_adk_user_id</code>.","children":[],"payload":{"tag":"li","lines":"296,297"}},{"content":"<strong>Sessions</strong>: <code>chat/page.tsx</code> &#x2192; <code>listSessions(token)</code> / <code>createSession(token)</code> &#x2192; backend JWT &#x2192; <code>session_service</code> &#x2192; cookie <code>copilot_adk_session_id</code> (+ optional <code>POST /api/session</code>).","children":[],"payload":{"tag":"li","lines":"297,298"}},{"content":"<strong>Chat message</strong>: User types &#x2192; CopilotKit &#x2192; POST <code>/api/copilotkit</code> (cookies sent) &#x2192; Next.js reads cookies &#x2192; HttpAgent POST <code>/ag-ui</code> with <code>X-User-Id</code>, <code>X-Session-Id</code> &#x2192; backend <code>extract_user_and_session</code> &#x2192; state <code>_ag_ui_user_id</code>, <code>_ag_ui_session_id</code> &#x2192; <code>user_id_extractor</code> &#x2192; ADKAgent + session_service load/update session by (user_id, session_id) &#x2192; response back to UI.","children":[],"payload":{"tag":"li","lines":"298,299"}},{"content":"<strong>History</strong>: On session select, <code>getSessionHistory(sessionId, user_id)</code> &#x2192; POST <code>/agents/state</code> (threadId = sessionId) &#x2192; ag-ui-adk + session_service return state/messages &#x2192; frontend renders previous messages.","children":[],"payload":{"tag":"li","lines":"299,301"}}],"payload":{"tag":"h2","lines":"294,295"}},{"content":"8. File reference (paths)","children":[{"content":"<table data-lines=\"305,316\">\n<thead data-lines=\"305,306\">\n<tr data-lines=\"305,306\">\n<th>Role</th>\n<th>App path</th>\n</tr>\n</thead>\n<tbody data-lines=\"307,316\">\n<tr data-lines=\"307,308\">\n<td>Login form</td>\n<td><code>frontend/app/login/page.tsx</code></td>\n</tr>\n<tr data-lines=\"308,309\">\n<td>Auth state + cookie on login</td>\n<td><code>frontend/contexts/AuthContext.tsx</code></td>\n</tr>\n<tr data-lines=\"309,310\">\n<td>Token/user localStorage</td>\n<td><code>frontend/lib/auth.ts</code></td>\n</tr>\n<tr data-lines=\"310,311\">\n<td>Session list/create API client</td>\n<td><code>frontend/lib/api.ts</code></td>\n</tr>\n<tr data-lines=\"311,312\">\n<td>Chat UI + CopilotKit + cookies</td>\n<td><code>frontend/app/chat/page.tsx</code></td>\n</tr>\n<tr data-lines=\"312,313\">\n<td>Set cookies via API</td>\n<td><code>frontend/app/api/session/route.ts</code></td>\n</tr>\n<tr data-lines=\"313,314\">\n<td>CopilotKit &#x2192; backend proxy</td>\n<td><code>frontend/app/api/copilotkit/route.ts</code></td>\n</tr>\n<tr data-lines=\"314,315\">\n<td>Auth + session REST + AG-UI</td>\n<td><code>backend/main.py</code></td>\n</tr>\n<tr data-lines=\"315,316\">\n<td>Session service (Postgres)</td>\n<td><code>backend/agent.py</code></td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"305,316"}}],"payload":{"tag":"h2","lines":"303,304"}}],"payload":{"tag":"h1","lines":"6,7"}},{"colorFreezeLevel":2})</script>
</body>
</html>
