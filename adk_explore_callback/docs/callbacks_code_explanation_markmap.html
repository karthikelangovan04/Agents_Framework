<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
html {
  font-family: ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.markmap-dark {
  background: #27272a;
  color: white;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js"></script><script>(()=>{setTimeout(()=>{const{markmap:S,mm:Q}=window,$=new S.Toolbar;$.attach(Q);const I=$.render();I.setAttribute("style","position:absolute;bottom:20px;right:20px"),document.body.append(I)})})()</script><script>((l,U,M,R)=>{const N=l();window.mm=N.Markmap.create("svg#mindmap",(U||N.deriveOptions)(R),M),window.matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.classList.add("markmap-dark")})(()=>window.markmap,null,{"content":"callback_plugin_agent_full_demo.py","children":[{"content":"Overview","children":[{"content":"<strong>Purpose</strong>: Demonstrates ALL Plugin + Agent callbacks with SQLite cache and sensitive data detection","children":[],"payload":{"tag":"li","lines":"9,10"}},{"content":"<strong>Key features</strong>: Plugin runs first, Agent runs after, Cache short-circuits LLM, Sensitive data skips agent","children":[],"payload":{"tag":"li","lines":"10,11"}},{"content":"<strong>Run</strong>: <code>GEMINI_MODEL=gemini-2.5-flash uv run python callback_plugin_agent_full_demo.py</code>","children":[],"payload":{"tag":"li","lines":"11,13"}}],"payload":{"tag":"h2","lines":"8,9"}},{"content":"1. Configuration &amp; Constants","children":[{"content":"Globals","children":[{"content":"<code>APP_NAME</code> = &quot;callback_plugin_agent_full_demo&quot;","children":[],"payload":{"tag":"li","lines":"18,19"}},{"content":"<code>GEMINI_MODEL</code> from env (default: gemini-2.5-flash)","children":[],"payload":{"tag":"li","lines":"19,20"}},{"content":"<code>DB_PATH</code> = <code>llm_cache.db</code> (SQLite)","children":[],"payload":{"tag":"li","lines":"20,21"}},{"content":"<code>_cache_key_by_session</code> = dict (pass cache key between before_model and after_model)","children":[],"payload":{"tag":"li","lines":"21,23"}}],"payload":{"tag":"h3","lines":"17,18"}},{"content":"Regex Patterns","children":[{"content":"<code>NPI_PATTERN</code> = <code>\\b(\\d{10})\\b</code> (10-digit National Provider Identifier)","children":[],"payload":{"tag":"li","lines":"24,25"}},{"content":"<code>PCI_PATTERN</code> = credit card (4 groups of 4 digits, optional spaces/dashes)","children":[],"payload":{"tag":"li","lines":"25,27"}}],"payload":{"tag":"h3","lines":"23,24"}}],"payload":{"tag":"h2","lines":"15,16"}},{"content":"2. Helper Functions","children":[{"content":"Sensitive Data","children":[{"content":"<code>_has_sensitive_data(text)</code> &#x2192; bool","children":[{"content":"Returns True if NPI or valid PCI (13&#x2013;19 digits) found","children":[],"payload":{"tag":"li","lines":"33,34"}},{"content":"Used in <code>on_user_message_callback</code>","children":[],"payload":{"tag":"li","lines":"34,36"}}],"payload":{"tag":"li","lines":"32,36"}}],"payload":{"tag":"h3","lines":"31,32"}},{"content":"Content Extraction","children":[{"content":"<code>_get_text_from_content(c)</code> &#x2192; str","children":[{"content":"Extracts text from <code>Content.parts</code>","children":[],"payload":{"tag":"li","lines":"38,39"}}],"payload":{"tag":"li","lines":"37,39"}},{"content":"<code>_extract_text_from_response(llm_response)</code> &#x2192; str","children":[{"content":"Gets text from <code>LlmResponse.content</code>","children":[],"payload":{"tag":"li","lines":"40,41"}}],"payload":{"tag":"li","lines":"39,41"}},{"content":"<code>_make_cache_key(llm_request)</code> &#x2192; str","children":[{"content":"SHA256 hash of <code>role:text</code> for each content in request","children":[],"payload":{"tag":"li","lines":"42,43"}},{"content":"First 32 chars used as cache key","children":[],"payload":{"tag":"li","lines":"43,45"}}],"payload":{"tag":"li","lines":"41,45"}}],"payload":{"tag":"h3","lines":"36,37"}},{"content":"Cache","children":[{"content":"<code>_build_cached_response(text)</code> &#x2192; LlmResponse","children":[{"content":"Constructs <code>LlmResponse(content=Content(role=&quot;model&quot;, parts=[Part(text=text)]))</code>","children":[],"payload":{"tag":"li","lines":"47,48"}},{"content":"Used when returning cached or fallback response","children":[],"payload":{"tag":"li","lines":"48,50"}}],"payload":{"tag":"li","lines":"46,50"}}],"payload":{"tag":"h3","lines":"45,46"}},{"content":"SQLite","children":[{"content":"<code>init_cache_db()</code> &#x2192; Creates <code>llm_cache</code> table","children":[{"content":"Columns: <code>cache_key</code> (PK), <code>response_text</code>, <code>created_at</code>","children":[],"payload":{"tag":"li","lines":"52,54"}}],"payload":{"tag":"li","lines":"51,54"}}],"payload":{"tag":"h3","lines":"50,51"}}],"payload":{"tag":"h2","lines":"29,30"}},{"content":"3. FullDemoPlugin (extends BasePlugin)","children":[{"content":"Purpose","children":[{"content":"Logs every callback point","children":[],"payload":{"tag":"li","lines":"59,60"}},{"content":"Detects sensitive data (on_user_message)","children":[],"payload":{"tag":"li","lines":"60,61"}},{"content":"Skips agent when sensitive data (before_agent)","children":[],"payload":{"tag":"li","lines":"61,62"}},{"content":"Error fallbacks (on_model_error, on_tool_error)","children":[],"payload":{"tag":"li","lines":"62,64"}}],"payload":{"tag":"h3","lines":"58,59"}},{"content":"Callbacks Implemented","children":[{"content":"on_user_message_callback","children":[{"content":"<strong>Input</strong>: <code>invocation_context</code>, <code>user_message</code>","children":[],"payload":{"tag":"li","lines":"67,68"}},{"content":"<strong>Logic</strong>: Extract text &#x2192; if <code>_has_sensitive_data()</code> &#x2192; set <code>session.state[&quot;sensitive_data_detected&quot;] = True</code>","children":[],"payload":{"tag":"li","lines":"68,69"}},{"content":"<strong>Return</strong>: None (proceed)","children":[],"payload":{"tag":"li","lines":"69,70"}},{"content":"<strong>Log</strong>: &quot;User message received&quot;, &quot;*** SENSITIVE DATA DETECTED ***&quot; if found","children":[],"payload":{"tag":"li","lines":"70,72"}}],"payload":{"tag":"h4","lines":"66,67"}},{"content":"before_run_callback","children":[{"content":"<strong>Input</strong>: <code>invocation_context</code>","children":[],"payload":{"tag":"li","lines":"73,74"}},{"content":"<strong>Logic</strong>: Log","children":[],"payload":{"tag":"li","lines":"74,75"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"75,76"}},{"content":"<strong>Log</strong>: &quot;Runner starting&quot;","children":[],"payload":{"tag":"li","lines":"76,78"}}],"payload":{"tag":"h4","lines":"72,73"}},{"content":"after_run_callback","children":[{"content":"<strong>Input</strong>: <code>invocation_context</code>","children":[],"payload":{"tag":"li","lines":"79,80"}},{"content":"<strong>Logic</strong>: Log","children":[],"payload":{"tag":"li","lines":"80,81"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"81,82"}},{"content":"<strong>Log</strong>: &quot;Runner finished&quot;","children":[],"payload":{"tag":"li","lines":"82,84"}}],"payload":{"tag":"h4","lines":"78,79"}},{"content":"before_agent_callback","children":[{"content":"<strong>Input</strong>: <code>agent</code>, <code>callback_context</code>","children":[],"payload":{"tag":"li","lines":"85,86"}},{"content":"<strong>Logic</strong>: If <code>state.get(&quot;sensitive_data_detected&quot;)</code> &#x2192; return <code>Content</code> with warning message (SHORT-CIRCUIT)","children":[],"payload":{"tag":"li","lines":"86,87"}},{"content":"<strong>Return</strong>: Content (skip) or None (proceed)","children":[],"payload":{"tag":"li","lines":"87,88"}},{"content":"<strong>Log</strong>: &quot;Agent &apos;X&apos; about to run&quot;, &quot;Skipping agent - sensitive data&quot; if skip","children":[],"payload":{"tag":"li","lines":"88,90"}}],"payload":{"tag":"h4","lines":"84,85"}},{"content":"after_agent_callback","children":[{"content":"<strong>Input</strong>: <code>agent</code>, <code>callback_context</code>","children":[],"payload":{"tag":"li","lines":"91,92"}},{"content":"<strong>Logic</strong>: Log","children":[],"payload":{"tag":"li","lines":"92,93"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"93,94"}},{"content":"<strong>Log</strong>: &quot;Agent &apos;X&apos; finished&quot;","children":[],"payload":{"tag":"li","lines":"94,96"}}],"payload":{"tag":"h4","lines":"90,91"}},{"content":"before_model_callback","children":[{"content":"<strong>Input</strong>: <code>callback_context</code>, <code>llm_request</code>","children":[],"payload":{"tag":"li","lines":"97,98"}},{"content":"<strong>Logic</strong>: Log only (CachePlugin handles cache)","children":[],"payload":{"tag":"li","lines":"98,99"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"99,100"}},{"content":"<strong>Log</strong>: &quot;Before LLM call&quot;","children":[],"payload":{"tag":"li","lines":"100,102"}}],"payload":{"tag":"h4","lines":"96,97"}},{"content":"after_model_callback","children":[{"content":"<strong>Input</strong>: <code>callback_context</code>, <code>llm_response</code>","children":[],"payload":{"tag":"li","lines":"103,104"}},{"content":"<strong>Logic</strong>: Log only","children":[],"payload":{"tag":"li","lines":"104,105"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"105,106"}},{"content":"<strong>Log</strong>: &quot;After LLM call&quot;","children":[],"payload":{"tag":"li","lines":"106,108"}}],"payload":{"tag":"h4","lines":"102,103"}},{"content":"on_model_error_callback","children":[{"content":"<strong>Input</strong>: <code>callback_context</code>, <code>llm_request</code>, <code>error</code>","children":[],"payload":{"tag":"li","lines":"109,110"}},{"content":"<strong>Logic</strong>: Return fallback <code>LlmResponse</code> to suppress exception","children":[],"payload":{"tag":"li","lines":"110,111"}},{"content":"<strong>Return</strong>: <code>_build_cached_response(&quot;[Fallback] Model error: ...&quot;)</code>","children":[],"payload":{"tag":"li","lines":"111,112"}},{"content":"<strong>Log</strong>: &quot;Model error: {error}&quot;","children":[],"payload":{"tag":"li","lines":"112,114"}}],"payload":{"tag":"h4","lines":"108,109"}},{"content":"before_tool_callback","children":[{"content":"<strong>Input</strong>: <code>tool</code>, <code>tool_args</code>, <code>tool_context</code>","children":[],"payload":{"tag":"li","lines":"115,116"}},{"content":"<strong>Logic</strong>: Log","children":[],"payload":{"tag":"li","lines":"116,117"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"117,118"}},{"content":"<strong>Log</strong>: &quot;Tool &apos;X&apos; about to run, args={...}&quot;","children":[],"payload":{"tag":"li","lines":"118,120"}}],"payload":{"tag":"h4","lines":"114,115"}},{"content":"after_tool_callback","children":[{"content":"<strong>Input</strong>: <code>tool</code>, <code>tool_args</code>, <code>tool_context</code>, <code>result</code>","children":[],"payload":{"tag":"li","lines":"121,122"}},{"content":"<strong>Logic</strong>: Log","children":[],"payload":{"tag":"li","lines":"122,123"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"123,124"}},{"content":"<strong>Log</strong>: &quot;Tool &apos;X&apos; finished, result={...}&quot;","children":[],"payload":{"tag":"li","lines":"124,126"}}],"payload":{"tag":"h4","lines":"120,121"}},{"content":"on_tool_error_callback","children":[{"content":"<strong>Input</strong>: <code>tool</code>, <code>tool_args</code>, <code>tool_context</code>, <code>error</code>","children":[],"payload":{"tag":"li","lines":"127,128"}},{"content":"<strong>Logic</strong>: Return fallback dict to suppress exception","children":[],"payload":{"tag":"li","lines":"128,129"}},{"content":"<strong>Return</strong>: <code>{&quot;error&quot;: str(error), &quot;fallback&quot;: True}</code>","children":[],"payload":{"tag":"li","lines":"129,130"}},{"content":"<strong>Log</strong>: &quot;Tool &apos;X&apos; error: {error}&quot;","children":[],"payload":{"tag":"li","lines":"130,132"}}],"payload":{"tag":"h4","lines":"126,127"}},{"content":"on_event_callback","children":[{"content":"<strong>Input</strong>: <code>invocation_context</code>, <code>event</code>","children":[],"payload":{"tag":"li","lines":"133,134"}},{"content":"<strong>Logic</strong>: Log","children":[],"payload":{"tag":"li","lines":"134,135"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"135,136"}},{"content":"<strong>Log</strong>: &quot;Event from {author}&quot;","children":[],"payload":{"tag":"li","lines":"136,138"}}],"payload":{"tag":"h4","lines":"132,133"}}],"payload":{"tag":"h3","lines":"64,65"}}],"payload":{"tag":"h2","lines":"56,57"}},{"content":"4. CachePlugin (extends BasePlugin)","children":[{"content":"Purpose","children":[{"content":"Cache LLM responses in SQLite","children":[],"payload":{"tag":"li","lines":"143,144"}},{"content":"Key = hash of <code>llm_request.contents</code>","children":[],"payload":{"tag":"li","lines":"144,145"}},{"content":"before_model: check cache, return cached LlmResponse if hit","children":[],"payload":{"tag":"li","lines":"145,146"}},{"content":"after_model: store response in cache on miss (only final text, not function_call)","children":[],"payload":{"tag":"li","lines":"146,148"}}],"payload":{"tag":"h3","lines":"142,143"}},{"content":"before_model_callback","children":[{"content":"<strong>Input</strong>: <code>callback_context</code>, <code>llm_request</code>","children":[],"payload":{"tag":"li","lines":"149,150"}},{"content":"<strong>Logic</strong>:","children":[{"content":"1. <code>cache_key = _make_cache_key(llm_request)</code>","children":[],"payload":{"tag":"li","lines":"151,152","listIndex":1}},{"content":"2. Store key in <code>_cache_key_by_session[session_id]</code>","children":[],"payload":{"tag":"li","lines":"152,153","listIndex":2}},{"content":"3. Query SQLite: <code>SELECT response_text WHERE cache_key = ?</code>","children":[],"payload":{"tag":"li","lines":"153,154","listIndex":3}},{"content":"4. If row found &#x2192; return <code>_build_cached_response(row[0])</code> (SKIP LLM)","children":[],"payload":{"tag":"li","lines":"154,155","listIndex":4}}],"payload":{"tag":"li","lines":"150,155"}},{"content":"<strong>Return</strong>: LlmResponse (cache hit) or None (cache miss)","children":[],"payload":{"tag":"li","lines":"155,157"}}],"payload":{"tag":"h3","lines":"148,149"}},{"content":"after_model_callback","children":[{"content":"<strong>Input</strong>: <code>callback_context</code>, <code>llm_response</code>","children":[],"payload":{"tag":"li","lines":"158,159"}},{"content":"<strong>Logic</strong>:","children":[{"content":"1. <code>cache_key = _cache_key_by_session.pop(session_id)</code>","children":[],"payload":{"tag":"li","lines":"160,161","listIndex":1}},{"content":"2. Extract text from response","children":[],"payload":{"tag":"li","lines":"161,162","listIndex":2}},{"content":"3. Skip if response has <code>function_call</code> (intermediate, not final)","children":[],"payload":{"tag":"li","lines":"162,163","listIndex":3}},{"content":"4. If text and no function_call &#x2192; <code>INSERT OR REPLACE INTO llm_cache</code>","children":[],"payload":{"tag":"li","lines":"163,164","listIndex":4}}],"payload":{"tag":"li","lines":"159,164"}},{"content":"<strong>Return</strong>: None","children":[],"payload":{"tag":"li","lines":"164,166"}}],"payload":{"tag":"h3","lines":"157,158"}}],"payload":{"tag":"h2","lines":"140,141"}},{"content":"5. Tool: get_current_time","children":[{"content":"Definition","children":[{"content":"<strong>Function</strong>: <code>get_current_time(tool_context: ToolContext) -&gt; Dict[str, str]</code>","children":[],"payload":{"tag":"li","lines":"171,172"}},{"content":"<strong>Docstring</strong>: &quot;Returns current date and time. Call when user asks about time or date.&quot;","children":[],"payload":{"tag":"li","lines":"172,173"}},{"content":"<strong>Returns</strong>: <code>{current_time, current_date, timezone}</code>","children":[],"payload":{"tag":"li","lines":"173,174"}},{"content":"<strong>Wrapper</strong>: <code>FunctionTool(get_current_time)</code> &#x2192; <code>get_current_time_tool</code>","children":[],"payload":{"tag":"li","lines":"174,176"}}],"payload":{"tag":"h3","lines":"170,171"}}],"payload":{"tag":"h2","lines":"168,169"}},{"content":"6. Agent Callbacks (standalone functions)","children":[{"content":"Registered on Agent","children":[{"content":"<code>agent_before_agent(callback_context)</code> &#x2192; None, log","children":[],"payload":{"tag":"li","lines":"181,182"}},{"content":"<code>agent_after_agent(callback_context)</code> &#x2192; None, log","children":[],"payload":{"tag":"li","lines":"182,183"}},{"content":"<code>agent_before_model(callback_context, llm_request)</code> &#x2192; None, log","children":[],"payload":{"tag":"li","lines":"183,184"}},{"content":"<code>agent_after_model(callback_context, llm_response)</code> &#x2192; None, log","children":[],"payload":{"tag":"li","lines":"184,185"}},{"content":"<code>agent_before_tool(tool, args, tool_context)</code> &#x2192; None, log","children":[],"payload":{"tag":"li","lines":"185,186"}},{"content":"<code>agent_after_tool(tool, args, tool_context, tool_response)</code> &#x2192; None, log","children":[],"payload":{"tag":"li","lines":"186,188"}}],"payload":{"tag":"h3","lines":"180,181"}},{"content":"Execution Order","children":[{"content":"Plugin callback runs <strong>first</strong>","children":[],"payload":{"tag":"li","lines":"189,190"}},{"content":"Agent callback runs <strong>second</strong> (unless Plugin returned value and short-circuited)","children":[],"payload":{"tag":"li","lines":"190,192"}}],"payload":{"tag":"h3","lines":"188,189"}}],"payload":{"tag":"h2","lines":"178,179"}},{"content":"7. root_agent","children":[{"content":"Configuration","children":[{"content":"<strong>name</strong>: full_demo_agent","children":[],"payload":{"tag":"li","lines":"197,198"}},{"content":"<strong>model</strong>: GEMINI_MODEL (gemini-2.5-flash)","children":[],"payload":{"tag":"li","lines":"198,199"}},{"content":"<strong>description</strong>: &quot;Helpful assistant - tells time.&quot;","children":[],"payload":{"tag":"li","lines":"199,200"}},{"content":"<strong>instruction</strong>: &quot;You are helpful. Use get_current_time when asked about time. Be concise.&quot;","children":[],"payload":{"tag":"li","lines":"200,201"}},{"content":"<strong>tools</strong>: [get_current_time_tool]","children":[],"payload":{"tag":"li","lines":"201,202"}},{"content":"<strong>callbacks</strong>: All 6 agent callbacks attached","children":[],"payload":{"tag":"li","lines":"202,204"}}],"payload":{"tag":"h3","lines":"196,197"}}],"payload":{"tag":"h2","lines":"194,195"}},{"content":"8. Main Flow (main())","children":[{"content":"Setup","children":[{"content":"1. <code>init_cache_db()</code> &#x2192; create llm_cache table","children":[],"payload":{"tag":"li","lines":"209,210","listIndex":1}},{"content":"2. Open output file <code>callback_plugin_agent_full_demo_output_{timestamp}.txt</code>","children":[],"payload":{"tag":"li","lines":"210,211","listIndex":2}},{"content":"3. Tee stdout/stderr to file","children":[],"payload":{"tag":"li","lines":"211,212","listIndex":3}},{"content":"4. Create <code>FullDemoPlugin()</code> and <code>CachePlugin()</code>","children":[],"payload":{"tag":"li","lines":"212,213","listIndex":4}},{"content":"5. Create <code>Runner(agent=root_agent, plugins=[full_plugin, cache_plugin], ...)</code>","children":[],"payload":{"tag":"li","lines":"213,214","listIndex":5}},{"content":"6. Create session <code>full_demo_{timestamp}</code>","children":[],"payload":{"tag":"li","lines":"214,216","listIndex":6}}],"payload":{"tag":"h3","lines":"208,209"}},{"content":"Test 1: Normal Question","children":[{"content":"<strong>Message</strong>: &quot;What time is it right now?&quot;","children":[],"payload":{"tag":"li","lines":"217,218"}},{"content":"<strong>Flow</strong>:","children":[{"content":"on_user_message &#x2192; no sensitive data","children":[],"payload":{"tag":"li","lines":"219,220"}},{"content":"before_run, before_agent &#x2192; proceed","children":[],"payload":{"tag":"li","lines":"220,221"}},{"content":"before_model &#x2192; cache miss (FullDemoPlugin logs, CachePlugin checks)","children":[],"payload":{"tag":"li","lines":"221,222"}},{"content":"LLM returns function_call &#x2192; get_current_time","children":[],"payload":{"tag":"li","lines":"222,223"}},{"content":"before_tool, tool runs, after_tool","children":[],"payload":{"tag":"li","lines":"223,224"}},{"content":"before_model (2nd) &#x2192; cache miss","children":[],"payload":{"tag":"li","lines":"224,225"}},{"content":"LLM returns text","children":[],"payload":{"tag":"li","lines":"225,226"}},{"content":"after_model &#x2192; CachePlugin stores in SQLite","children":[],"payload":{"tag":"li","lines":"226,227"}},{"content":"after_agent, after_run","children":[],"payload":{"tag":"li","lines":"227,228"}}],"payload":{"tag":"li","lines":"218,228"}},{"content":"<strong>Output</strong>: &quot;The current time is 07:34:46 on 2026-02-12.&quot;","children":[],"payload":{"tag":"li","lines":"228,230"}}],"payload":{"tag":"h3","lines":"216,217"}},{"content":"Test 2: Same Question (Cache Hit)","children":[{"content":"<strong>Session</strong>: New session <code>full_demo_cache_{timestamp}</code>","children":[],"payload":{"tag":"li","lines":"231,232"}},{"content":"<strong>Message</strong>: Same &quot;What time is it right now?&quot;","children":[],"payload":{"tag":"li","lines":"232,233"}},{"content":"<strong>Flow</strong>:","children":[{"content":"Same prompt &#x2192; same cache_key","children":[],"payload":{"tag":"li","lines":"234,235"}},{"content":"before_model (2nd call, after tool) &#x2192; CachePlugin CACHE HIT","children":[],"payload":{"tag":"li","lines":"235,236"}},{"content":"Returns cached LlmResponse &#x2192; LLM NOT called","children":[],"payload":{"tag":"li","lines":"236,237"}},{"content":"Agent model callbacks SKIPPED (Plugin returned value)","children":[],"payload":{"tag":"li","lines":"237,238"}}],"payload":{"tag":"li","lines":"233,238"}},{"content":"<strong>Output</strong>: Cached time from Test 1","children":[],"payload":{"tag":"li","lines":"238,240"}}],"payload":{"tag":"h3","lines":"230,231"}},{"content":"Test 3: Sensitive Data","children":[{"content":"<strong>Message</strong>: &quot;My NPI is 1234567890 and my card is 4111 1111 1111 1111. Help me.&quot;","children":[],"payload":{"tag":"li","lines":"241,242"}},{"content":"<strong>Flow</strong>:","children":[{"content":"on_user_message &#x2192; <code>_has_sensitive_data()</code> True &#x2192; <code>state[&quot;sensitive_data_detected&quot;] = True</code>","children":[],"payload":{"tag":"li","lines":"243,244"}},{"content":"before_run &#x2192; proceed","children":[],"payload":{"tag":"li","lines":"244,245"}},{"content":"before_agent (Plugin) &#x2192; checks state &#x2192; returns Content (SHORT-CIRCUIT)","children":[],"payload":{"tag":"li","lines":"245,246"}},{"content":"Agent callbacks SKIPPED, Agent logic SKIPPED, Model SKIPPED, Tool SKIPPED","children":[],"payload":{"tag":"li","lines":"246,247"}},{"content":"on_event (Plugin) &#x2192; Event with returned Content","children":[],"payload":{"tag":"li","lines":"247,248"}},{"content":"after_run &#x2192; done","children":[],"payload":{"tag":"li","lines":"248,249"}}],"payload":{"tag":"li","lines":"242,249"}},{"content":"<strong>Output</strong>: &quot;Your message contains sensitive data (NPI or credit card detected). Please rephrase without sharing such information.&quot;","children":[],"payload":{"tag":"li","lines":"249,251"}}],"payload":{"tag":"h3","lines":"240,241"}}],"payload":{"tag":"h2","lines":"206,207"}},{"content":"9. TeeOutput Class","children":[{"content":"<strong>Purpose</strong>: Write to both console and file","children":[],"payload":{"tag":"li","lines":"255,256"}},{"content":"<strong>Methods</strong>: <code>write(msg)</code>, <code>flush()</code>","children":[],"payload":{"tag":"li","lines":"256,257"}},{"content":"<strong>Usage</strong>: <code>sys.stdout = TeeOutput(file_handle, sys.stdout)</code>","children":[],"payload":{"tag":"li","lines":"257,259"}}],"payload":{"tag":"h2","lines":"253,254"}},{"content":"10. Data Flow Diagram (Conceptual)","children":[{"content":"<pre data-lines=\"263,297\"><code data-lines=\"263,297\">User Message\n    &#x2193;\non_user_message (Plugin) &#x2500;&#x2500;&#x25ba; <span class=\"hljs-selector-attr\">[sensitive?]</span> &#x2192; state\n    &#x2193;\nbefore_run (Plugin)\n    &#x2193;\nbefore_agent (Plugin) &#x2500;&#x2500;&#x25ba; <span class=\"hljs-selector-attr\">[sensitive?]</span> &#x2192; return <span class=\"hljs-attribute\">Content</span> &#x2192; DONE\n    &#x2193;\nbefore_agent (Agent)\n    &#x2193;\nbefore_model (Plugin)\nbefore_model (CachePlugin) &#x2500;&#x2500;&#x25ba; <span class=\"hljs-selector-attr\">[cache hit?]</span> &#x2192; return LlmResponse &#x2192; skip LLM\n    &#x2193;\nbefore_model (Agent)\n    &#x2193;\nLLM call (or cached)\n    &#x2193;\nafter_model (Plugin)\nafter_model (CachePlugin) &#x2500;&#x2500;&#x25ba; <span class=\"hljs-selector-attr\">[no function_call?]</span> &#x2192; INSERT cache\n    &#x2193;\nafter_model (Agent)\n    &#x2193;\n<span class=\"hljs-selector-attr\">[if function_call]</span> before_tool &#x2192; tool &#x2192; after_tool\n    &#x2193;\non_event (Plugin) <span class=\"hljs-selector-attr\">[per event]</span>\n    &#x2193;\nafter_agent (Plugin)\nafter_agent (Agent)\n    &#x2193;\nafter_run (Plugin)\n    &#x2193;\nEvents to client\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"263,297"}}],"payload":{"tag":"h2","lines":"261,262"}},{"content":"11. File Outputs","children":[{"content":"<strong>Log</strong>: <code>callback_plugin_agent_full_demo_output_{timestamp}.txt</code>","children":[],"payload":{"tag":"li","lines":"302,303"}},{"content":"<strong>Cache DB</strong>: <code>llm_cache.db</code> (table: llm_cache)","children":[],"payload":{"tag":"li","lines":"303,304"}}],"payload":{"tag":"h2","lines":"300,301"}}],"payload":{"tag":"h1","lines":"6,7"}},{"colorFreezeLevel":2})</script>
</body>
</html>
