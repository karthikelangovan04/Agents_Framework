<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
html {
  font-family: ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.markmap-dark {
  background: #27272a;
  color: white;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js"></script><script>(()=>{setTimeout(()=>{const{markmap:S,mm:Q}=window,$=new S.Toolbar;$.attach(Q);const I=$.render();I.setAttribute("style","position:absolute;bottom:20px;right:20px"),document.body.append(I)})})()</script><script>((l,U,M,R)=>{const N=l();window.mm=N.Markmap.create("svg#mindmap",(U||N.deriveOptions)(R),M),window.matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.classList.add("markmap-dark")})(()=>window.markmap,null,{"content":"ADK: Runner &#x2192; Agent &#x2192; Model &#x2192; Tool","children":[{"content":"High-Level Flow","children":[{"content":"1. Runner","children":[{"content":"<strong>Entry point</strong> for agent execution","children":[],"payload":{"tag":"li","lines":"11,12"}},{"content":"Receives <code>user_message</code>, manages session","children":[],"payload":{"tag":"li","lines":"12,13"}},{"content":"Registers <strong>Plugins</strong> (global scope)","children":[],"payload":{"tag":"li","lines":"13,14"}},{"content":"Orchestrates: Runner callbacks &#x2192; Agent &#x2192; Model &#x2192; Tool","children":[],"payload":{"tag":"li","lines":"14,15"}},{"content":"Emits <strong>Events</strong> to client","children":[],"payload":{"tag":"li","lines":"15,17"}}],"payload":{"tag":"h3","lines":"10,11"}},{"content":"2. Agent","children":[{"content":"<strong>Single agent</strong> (e.g., LlmAgent) with instructions and tools","children":[],"payload":{"tag":"li","lines":"18,19"}},{"content":"Has <strong>Agent callbacks</strong> (local scope)","children":[],"payload":{"tag":"li","lines":"19,20"}},{"content":"Decides: call LLM, call tool, or respond","children":[],"payload":{"tag":"li","lines":"20,21"}},{"content":"Runs <code>_run_async_impl</code> (main logic)","children":[],"payload":{"tag":"li","lines":"21,23"}}],"payload":{"tag":"h3","lines":"17,18"}},{"content":"3. Model","children":[{"content":"<strong>LLM</strong> (e.g., Gemini) invoked for generation","children":[],"payload":{"tag":"li","lines":"24,25"}},{"content":"Receives <code>LlmRequest</code> (contents, system instruction, tools)","children":[],"payload":{"tag":"li","lines":"25,26"}},{"content":"Returns <code>LlmResponse</code> (text, function_call, etc.)","children":[],"payload":{"tag":"li","lines":"26,27"}},{"content":"<strong>Model callbacks</strong> wrap before/after the API call","children":[],"payload":{"tag":"li","lines":"27,29"}}],"payload":{"tag":"h3","lines":"23,24"}},{"content":"4. Tool","children":[{"content":"<strong>Function</strong> or <strong>AgentTool</strong> (e.g., <code>get_current_time</code>)","children":[],"payload":{"tag":"li","lines":"30,31"}},{"content":"Executed when LLM returns <code>function_call</code>","children":[],"payload":{"tag":"li","lines":"31,32"}},{"content":"Result passed back to LLM as <code>function_response</code>","children":[],"payload":{"tag":"li","lines":"32,33"}},{"content":"<strong>Tool callbacks</strong> wrap before/after execution","children":[],"payload":{"tag":"li","lines":"33,35"}}],"payload":{"tag":"h3","lines":"29,30"}}],"payload":{"tag":"h2","lines":"8,9"}},{"content":"Plugin vs Agent Callbacks","children":[{"content":"Plugin Callbacks (Global, Run First)","children":[{"content":"<table data-lines=\"45,59\">\n<thead data-lines=\"45,46\">\n<tr data-lines=\"45,46\">\n<th>Hook</th>\n<th>When</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody data-lines=\"47,59\">\n<tr data-lines=\"47,48\">\n<td><code>on_user_message</code></td>\n<td>User sends message</td>\n<td>Inspect/modify user input</td>\n</tr>\n<tr data-lines=\"48,49\">\n<td><code>before_run</code></td>\n<td>Runner starts</td>\n<td>Global setup</td>\n</tr>\n<tr data-lines=\"49,50\">\n<td><code>after_run</code></td>\n<td>Runner ends</td>\n<td>Cleanup, final logs</td>\n</tr>\n<tr data-lines=\"50,51\">\n<td><code>before_agent</code></td>\n<td>Before agent logic</td>\n<td>Skip agent if needed</td>\n</tr>\n<tr data-lines=\"51,52\">\n<td><code>after_agent</code></td>\n<td>After agent finishes</td>\n<td>Post-process</td>\n</tr>\n<tr data-lines=\"52,53\">\n<td><code>before_model</code></td>\n<td>Before LLM call</td>\n<td>Cache, guardrails</td>\n</tr>\n<tr data-lines=\"53,54\">\n<td><code>after_model</code></td>\n<td>After LLM returns</td>\n<td>Store cache, sanitize</td>\n</tr>\n<tr data-lines=\"54,55\">\n<td><code>on_model_error</code></td>\n<td>Model fails</td>\n<td>Fallback response</td>\n</tr>\n<tr data-lines=\"55,56\">\n<td><code>before_tool</code></td>\n<td>Before tool runs</td>\n<td>Validate args</td>\n</tr>\n<tr data-lines=\"56,57\">\n<td><code>after_tool</code></td>\n<td>After tool returns</td>\n<td>Log, modify result</td>\n</tr>\n<tr data-lines=\"57,58\">\n<td><code>on_tool_error</code></td>\n<td>Tool fails</td>\n<td>Fallback dict</td>\n</tr>\n<tr data-lines=\"58,59\">\n<td><code>on_event</code></td>\n<td>Each Event yielded</td>\n<td>Modify event</td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"45,59"}}],"payload":{"tag":"h3","lines":"39,40"}},{"content":"Agent Callbacks (Local, Run After Plugin)","children":[{"content":"<table data-lines=\"65,73\">\n<thead data-lines=\"65,66\">\n<tr data-lines=\"65,66\">\n<th>Hook</th>\n<th>Same as Plugin</th>\n<th>Agent-specific logic</th>\n</tr>\n</thead>\n<tbody data-lines=\"67,73\">\n<tr data-lines=\"67,68\">\n<td><code>before_agent</code></td>\n<td>&#x2713;</td>\n<td>Setup state for agent</td>\n</tr>\n<tr data-lines=\"68,69\">\n<td><code>after_agent</code></td>\n<td>&#x2713;</td>\n<td>Modify agent output</td>\n</tr>\n<tr data-lines=\"69,70\">\n<td><code>before_model</code></td>\n<td>&#x2713;</td>\n<td>Inject instructions</td>\n</tr>\n<tr data-lines=\"70,71\">\n<td><code>after_model</code></td>\n<td>&#x2713;</td>\n<td>Format response</td>\n</tr>\n<tr data-lines=\"71,72\">\n<td><code>before_tool</code></td>\n<td>&#x2713;</td>\n<td>Validate tool args</td>\n</tr>\n<tr data-lines=\"72,73\">\n<td><code>after_tool</code></td>\n<td>&#x2713;</td>\n<td>Save to state</td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"65,73"}}],"payload":{"tag":"h3","lines":"60,61"}}],"payload":{"tag":"h2","lines":"37,38"}},{"content":"Execution Order (Single User Message)","children":[{"content":"<pre data-lines=\"78,109\"><code data-lines=\"78,109\"><span class=\"hljs-selector-tag\">Runner</span><span class=\"hljs-selector-class\">.run_async</span>(new_message)\n  &#x2502;\n  &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">on_user_message_callback</span>\n  &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">before_run_callback</span>\n  &#x2502;\n  &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">before_agent_callback</span>  &#x2500;&#x2500;&#x25ba; <span class=\"hljs-selector-tag\">if</span> <span class=\"hljs-selector-tag\">returns</span> <span class=\"hljs-selector-tag\">Content</span>: <span class=\"hljs-selector-tag\">SKIP</span> <span class=\"hljs-selector-tag\">agent</span>\n  &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Agent]</span>  <span class=\"hljs-selector-tag\">before_agent_callback</span>\n  &#x2502;     &#x2502;\n  &#x2502;     &#x2514;&#x2500; <span class=\"hljs-selector-tag\">Agent</span> <span class=\"hljs-selector-tag\">main</span> <span class=\"hljs-selector-tag\">logic</span>\n  &#x2502;         &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">before_model_callback</span>  &#x2500;&#x2500;&#x25ba; <span class=\"hljs-selector-tag\">if</span> <span class=\"hljs-selector-tag\">returns</span> <span class=\"hljs-selector-tag\">LlmResponse</span>: <span class=\"hljs-selector-tag\">SKIP</span> <span class=\"hljs-selector-tag\">LLM</span>\n  &#x2502;         &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Agent]</span>  <span class=\"hljs-selector-tag\">before_model_callback</span>\n  &#x2502;         &#x2502;     &#x2514;&#x2500; <span class=\"hljs-selector-tag\">LLM</span> <span class=\"hljs-selector-tag\">call</span> (or cached)\n  &#x2502;         &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">after_model_callback</span>\n  &#x2502;         &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Agent]</span>  <span class=\"hljs-selector-tag\">after_model_callback</span>\n  &#x2502;         &#x2502;\n  &#x2502;         &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[if function_call]</span>\n  &#x2502;         &#x2502;   &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">before_tool_callback</span>  &#x2500;&#x2500;&#x25ba; <span class=\"hljs-selector-tag\">if</span> <span class=\"hljs-selector-tag\">returns</span> <span class=\"hljs-selector-tag\">dict</span>: <span class=\"hljs-selector-tag\">SKIP</span> <span class=\"hljs-selector-tag\">tool</span>\n  &#x2502;         &#x2502;   &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Agent]</span>  <span class=\"hljs-selector-tag\">before_tool_callback</span>\n  &#x2502;         &#x2502;   &#x2502;     &#x2514;&#x2500; <span class=\"hljs-selector-tag\">Tool</span> <span class=\"hljs-selector-tag\">execution</span>\n  &#x2502;         &#x2502;   &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">after_tool_callback</span>\n  &#x2502;         &#x2502;   &#x2514;&#x2500; <span class=\"hljs-selector-attr\">[Agent]</span>  <span class=\"hljs-selector-tag\">after_tool_callback</span>\n  &#x2502;         &#x2502;\n  &#x2502;         &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">on_event_callback</span> (per Event)\n  &#x2502;         &#x2514;&#x2500; <span class=\"hljs-selector-attr\">[repeat model/tool as needed]</span>\n  &#x2502;\n  &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">after_agent_callback</span>\n  &#x251c;&#x2500; <span class=\"hljs-selector-attr\">[Agent]</span>  <span class=\"hljs-selector-tag\">after_agent_callback</span>\n  &#x2502;\n  &#x2514;&#x2500; <span class=\"hljs-selector-attr\">[Plugin]</span> <span class=\"hljs-selector-tag\">after_run_callback</span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"78,109"}}],"payload":{"tag":"h2","lines":"76,77"}},{"content":"Scenario 1: Normal Question (&quot;What time is it?&quot;)","children":[{"content":"1. <strong>on_user_message</strong> &#x2192; No sensitive data, proceed","children":[],"payload":{"tag":"li","lines":"114,115","listIndex":1}},{"content":"2. <strong>before_run</strong> &#x2192; Log","children":[],"payload":{"tag":"li","lines":"115,116","listIndex":2}},{"content":"3. <strong>before_agent</strong> &#x2192; Proceed","children":[],"payload":{"tag":"li","lines":"116,117","listIndex":3}},{"content":"4. <strong>before_agent (Agent)</strong> &#x2192; Proceed","children":[],"payload":{"tag":"li","lines":"117,118","listIndex":4}},{"content":"5. <strong>before_model</strong> &#x2192; Cache miss","children":[],"payload":{"tag":"li","lines":"118,119","listIndex":5}},{"content":"6. <strong>LLM</strong> returns <code>function_call: get_current_time</code>","children":[],"payload":{"tag":"li","lines":"119,120","listIndex":6}},{"content":"7. <strong>after_model</strong> &#x2192; (no text, skip cache store)","children":[],"payload":{"tag":"li","lines":"120,121","listIndex":7}},{"content":"8. <strong>before_tool</strong> &#x2192; Log","children":[],"payload":{"tag":"li","lines":"121,122","listIndex":8}},{"content":"9. <strong>Tool</strong> runs &#x2192; <code>{current_time: &quot;07:34:46&quot;, ...}</code>","children":[],"payload":{"tag":"li","lines":"122,123","listIndex":9}},{"content":"10. <strong>after_tool</strong> &#x2192; Log","children":[],"payload":{"tag":"li","lines":"123,124","listIndex":10}},{"content":"11. <strong>before_model</strong> (2nd) &#x2192; Cache miss","children":[],"payload":{"tag":"li","lines":"124,125","listIndex":11}},{"content":"12. <strong>LLM</strong> returns text: &quot;The current time is 07:34:46...&quot;","children":[],"payload":{"tag":"li","lines":"125,126","listIndex":12}},{"content":"13. <strong>after_model</strong> &#x2192; <strong>Cache stored</strong> in SQLite","children":[],"payload":{"tag":"li","lines":"126,127","listIndex":13}},{"content":"14. <strong>after_agent</strong> &#x2192; Done","children":[],"payload":{"tag":"li","lines":"127,128","listIndex":14}},{"content":"15. <strong>Response</strong> streamed to user","children":[],"payload":{"tag":"li","lines":"128,130","listIndex":15}}],"payload":{"tag":"h2","lines":"112,113"}},{"content":"Scenario 2: Same Question (Cache Hit)","children":[{"content":"1. <strong>on_user_message</strong> &#x2192; Proceed","children":[],"payload":{"tag":"li","lines":"134,135","listIndex":1}},{"content":"2. <strong>before_run</strong> &#x2192; Log","children":[],"payload":{"tag":"li","lines":"135,136","listIndex":2}},{"content":"3. <strong>before_agent</strong> &#x2192; Proceed","children":[],"payload":{"tag":"li","lines":"136,137","listIndex":3}},{"content":"4. <strong>before_model</strong> &#x2192; <strong>CACHE HIT</strong> &#x2192; Return cached <code>LlmResponse</code>","children":[],"payload":{"tag":"li","lines":"137,138","listIndex":4}},{"content":"5. <strong>Agent model callback</strong> &#x2192; <strong>SKIPPED</strong> (Plugin returned value)","children":[],"payload":{"tag":"li","lines":"138,139","listIndex":5}},{"content":"6. <strong>LLM</strong> &#x2192; <strong>NOT CALLED</strong>","children":[],"payload":{"tag":"li","lines":"139,140","listIndex":6}},{"content":"7. <strong>Response</strong> from cache: &quot;The current time is 07:34:46...&quot;","children":[],"payload":{"tag":"li","lines":"140,142","listIndex":7}}],"payload":{"tag":"h2","lines":"132,133"}},{"content":"Scenario 3: Sensitive Data (NPI + PCI) &#x2014; Complete Flow","children":[{"content":"User Message","children":[{"content":"&quot;My NPI is 1234567890 and my card is 4111 1111 1111 1111. Help me.&quot;","children":[],"payload":{"tag":"li","lines":"147,149"}}],"payload":{"tag":"h3","lines":"146,147"}},{"content":"Step-by-Step","children":[{"content":"1. \n<p data-lines=\"151,152\"><strong>on_user_message_callback (Plugin)</strong></p>","children":[{"content":"Detects NPI pattern <code>\\b\\d{10}\\b</code>","children":[],"payload":{"tag":"li","lines":"152,153"}},{"content":"Detects PCI pattern (credit card)","children":[],"payload":{"tag":"li","lines":"153,154"}},{"content":"Sets <code>session.state[&quot;sensitive_data_detected&quot;] = True</code>","children":[],"payload":{"tag":"li","lines":"154,155"}},{"content":"Returns <code>None</code> &#x2192; proceed","children":[],"payload":{"tag":"li","lines":"155,157"}}],"payload":{"tag":"li","lines":"151,157","listIndex":1}},{"content":"2. \n<p data-lines=\"157,158\"><strong>before_run_callback (Plugin)</strong></p>","children":[{"content":"Logs &quot;Runner starting&quot;","children":[],"payload":{"tag":"li","lines":"158,159"}},{"content":"Returns <code>None</code>","children":[],"payload":{"tag":"li","lines":"159,161"}}],"payload":{"tag":"li","lines":"157,161","listIndex":2}},{"content":"3. \n<p data-lines=\"161,162\"><strong>before_agent_callback (Plugin)</strong></p>","children":[{"content":"Checks <code>callback_context.state.get(&quot;sensitive_data_detected&quot;)</code>","children":[],"payload":{"tag":"li","lines":"162,163"}},{"content":"<strong>True</strong> &#x2192; Returns <code>Content(role=&quot;model&quot;, parts=[Part(text=&quot;Your message contains sensitive data (NPI or credit card detected). Please rephrase without sharing such information.&quot;)])</code>","children":[],"payload":{"tag":"li","lines":"163,164"}},{"content":"<strong>Short-circuit</strong>: Agent callbacks and agent logic <strong>SKIPPED</strong>","children":[],"payload":{"tag":"li","lines":"164,166"}}],"payload":{"tag":"li","lines":"161,166","listIndex":3}},{"content":"4. \n<p data-lines=\"166,167\"><strong>Agent callbacks</strong> &#x2192; <strong>NOT RUN</strong></p>","children":[],"payload":{"tag":"li","lines":"166,168","listIndex":4}},{"content":"5. \n<p data-lines=\"168,169\"><strong>Model</strong> &#x2192; <strong>NOT CALLED</strong></p>","children":[],"payload":{"tag":"li","lines":"168,170","listIndex":5}},{"content":"6. \n<p data-lines=\"170,171\"><strong>Tool</strong> &#x2192; <strong>NOT CALLED</strong></p>","children":[],"payload":{"tag":"li","lines":"170,172","listIndex":6}},{"content":"7. \n<p data-lines=\"172,173\"><strong>on_event_callback (Plugin)</strong></p>","children":[{"content":"Event from agent (the returned Content)","children":[],"payload":{"tag":"li","lines":"173,175"}}],"payload":{"tag":"li","lines":"172,175","listIndex":7}},{"content":"8. \n<p data-lines=\"175,176\"><strong>after_run_callback (Plugin)</strong></p>","children":[{"content":"Logs &quot;Runner finished&quot;","children":[],"payload":{"tag":"li","lines":"176,178"}}],"payload":{"tag":"li","lines":"175,178","listIndex":8}}],"payload":{"tag":"h3","lines":"149,150"}},{"content":"Result","children":[{"content":"User receives: <em>&quot;Your message contains sensitive data (NPI or credit card detected). Please rephrase without sharing such information.&quot;</em>","children":[],"payload":{"tag":"li","lines":"179,180"}},{"content":"No LLM call, no tool call, no agent execution","children":[],"payload":{"tag":"li","lines":"180,181"}},{"content":"<strong>Plugin</strong> intercepts at <code>before_agent</code> and returns early","children":[],"payload":{"tag":"li","lines":"181,183"}}],"payload":{"tag":"h3","lines":"178,179"}}],"payload":{"tag":"h2","lines":"144,145"}},{"content":"Differentiation Summary","children":[{"content":"<table data-lines=\"187,192\">\n<thead data-lines=\"187,188\">\n<tr data-lines=\"187,188\">\n<th>Scenario</th>\n<th>Plugin Intervenes?</th>\n<th>Agent Runs?</th>\n<th>LLM Called?</th>\n<th>Tool Called?</th>\n</tr>\n</thead>\n<tbody data-lines=\"189,192\">\n<tr data-lines=\"189,190\">\n<td>Normal</td>\n<td>No</td>\n<td>Yes</td>\n<td>Yes</td>\n<td>Yes</td>\n</tr>\n<tr data-lines=\"190,191\">\n<td>Cache Hit</td>\n<td>Yes (before_model)</td>\n<td>Yes</td>\n<td>No</td>\n<td>No*</td>\n</tr>\n<tr data-lines=\"191,192\">\n<td>Sensitive</td>\n<td>Yes (before_agent)</td>\n<td>No</td>\n<td>No</td>\n<td>No</td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"187,192"}}],"payload":{"tag":"h2","lines":"185,186"}}],"payload":{"tag":"h1","lines":"6,7"}},{"colorFreezeLevel":2})</script>
</body>
</html>
