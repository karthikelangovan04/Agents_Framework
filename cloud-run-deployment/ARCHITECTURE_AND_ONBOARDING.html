<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
html {
  font-family: ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
.markmap-dark {
  background: #27272a;
  color: white;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js"></script><script>(()=>{setTimeout(()=>{const{markmap:S,mm:Q}=window,$=new S.Toolbar;$.attach(Q);const I=$.render();I.setAttribute("style","position:absolute;bottom:20px;right:20px"),document.body.append(I)})})()</script><script>((l,U,M,R)=>{const N=l();window.mm=N.Markmap.create("svg#mindmap",(U||N.deriveOptions)(R),M),window.matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.classList.add("markmap-dark")})(()=>window.markmap,null,{"content":"Cloud Run ADK Agent + MCP Server","children":[{"content":"1. Agent Logic (ADK Agent)","children":[{"content":"What It Is","children":[],"payload":{"tag":"h3","lines":"12,13"}},{"content":"Components","children":[{"content":"\n<p data-lines=\"17,18\"><strong>agent.py</strong></p>","children":[{"content":"<strong>What:</strong> Defines the LLM agent and MCP tool connection.","children":[],"payload":{"tag":"li","lines":"18,19"}},{"content":"<strong>Why:</strong> Central place for model, system instruction, and how the agent reaches the MCP server (URL, transport, auth).","children":[],"payload":{"tag":"li","lines":"19,20"}},{"content":"<strong>LlmAgent:</strong> Wraps Gemini with instruction and tools.","children":[],"payload":{"tag":"li","lines":"20,21"}},{"content":"<strong>MCPToolset:</strong> Loads tools from the remote MCP server (e.g. <code>get_exchange_rate</code>).","children":[],"payload":{"tag":"li","lines":"21,22"}},{"content":"<strong>SseConnectionParams:</strong> Connects to MCP over SSE (URL + optional headers).","children":[],"payload":{"tag":"li","lines":"22,23"}},{"content":"<strong>header_provider:</strong> Callback that returns auth headers when the MCP session is created (needed so ID token is fetched at connection time on Cloud Run, not at import time).","children":[],"payload":{"tag":"li","lines":"23,25"}}],"payload":{"tag":"li","lines":"17,25"}},{"content":"\n<p data-lines=\"25,26\"><strong>main.py</strong></p>","children":[{"content":"<strong>What:</strong> FastAPI app exposing <code>/</code>, <code>/health</code>, <code>/chat</code>.","children":[],"payload":{"tag":"li","lines":"26,27"}},{"content":"<strong>Why:</strong> Cloud Run needs an HTTP server; sessions and runner need to be wired once.","children":[],"payload":{"tag":"li","lines":"27,28"}},{"content":"<strong>Runner:</strong> Runs the agent with a session service (run_async streams events).","children":[],"payload":{"tag":"li","lines":"28,29"}},{"content":"<strong>InMemorySessionService:</strong> Stores conversation state per user/session (no DB).","children":[],"payload":{"tag":"li","lines":"29,30"}},{"content":"<strong>Session handling:</strong> Before run_async we ensure a session exists (create if missing) so the runner does not fail with &quot;Session not found&quot;.","children":[],"payload":{"tag":"li","lines":"30,31"}},{"content":"<strong>Port:</strong> Uses <code>PORT</code> from env (Cloud Run sets it, e.g. 8080).","children":[],"payload":{"tag":"li","lines":"31,33"}}],"payload":{"tag":"li","lines":"25,33"}},{"content":"\n<p data-lines=\"33,34\"><strong>auth_helper.py</strong></p>","children":[{"content":"<strong>What:</strong> Builds <code>Authorization: Bearer &lt;id_token&gt;</code> for requests to the MCP server.","children":[],"payload":{"tag":"li","lines":"34,35"}},{"content":"<strong>Why:</strong> MCP server is private; Cloud Run validates the ID token. Agent runs as a service account and gets the token via ADC.","children":[],"payload":{"tag":"li","lines":"35,36"}},{"content":"<strong>get_id_token(audience):</strong> Uses <code>id_token.fetch_id_token()</code> with Application Default Credentials; audience is the MCP service base URL (e.g. <code>https://mcp-server-xxx.run.app</code>).","children":[],"payload":{"tag":"li","lines":"36,37"}},{"content":"<strong>get_authenticated_headers(mcp_server_url):</strong> Parses URL to get base (scheme + netloc), gets ID token for that audience, returns headers dict. Used by agent as <code>header_provider</code>.","children":[],"payload":{"tag":"li","lines":"37,39"}}],"payload":{"tag":"li","lines":"33,39"}}],"payload":{"tag":"h3","lines":"15,16"}},{"content":"Flow (Request Path)","children":[{"content":"1. Request hits <code>/chat</code> with <code>message</code>, <code>session_id</code>, <code>user_id</code>.","children":[],"payload":{"tag":"li","lines":"41,42","listIndex":1}},{"content":"2. Session is ensured (get or create).","children":[],"payload":{"tag":"li","lines":"42,43","listIndex":2}},{"content":"3. Runner runs agent with the user message.","children":[],"payload":{"tag":"li","lines":"43,44","listIndex":3}},{"content":"4. Agent may open MCP session (header_provider called &#x2192; auth_helper &#x2192; ID token &#x2192; SSE connection with Bearer).","children":[],"payload":{"tag":"li","lines":"44,45","listIndex":4}},{"content":"5. LLM may call MCP tools (e.g. get_exchange_rate); MCP server responds.","children":[],"payload":{"tag":"li","lines":"45,46","listIndex":5}},{"content":"6. Response text is collected from runner events and returned as JSON.","children":[],"payload":{"tag":"li","lines":"46,48","listIndex":6}}],"payload":{"tag":"h3","lines":"39,40"}}],"payload":{"tag":"h2","lines":"10,11"}},{"content":"2. MCP Server Logic","children":[{"content":"What It Is","children":[],"payload":{"tag":"h3","lines":"52,53"}},{"content":"Components","children":[{"content":"<strong>server.py</strong>","children":[{"content":"<strong>What:</strong> FastMCP app with one tool, served over SSE.","children":[],"payload":{"tag":"li","lines":"58,59"}},{"content":"<strong>Why:</strong> Keeps tools in a separate service so the agent can call them remotely with auth.","children":[],"payload":{"tag":"li","lines":"59,60"}},{"content":"<strong>FastMCP:</strong> MCP framework; we use <code>transport=&quot;sse&quot;</code> and expose <code>/sse</code>.","children":[],"payload":{"tag":"li","lines":"60,61"}},{"content":"<strong>get_exchange_rate:</strong> Tool that calls Frankfurter API and returns rate data.","children":[],"payload":{"tag":"li","lines":"61,62"}},{"content":"<strong>Host 0.0.0.0:</strong> So Cloud Run can send traffic to the container.","children":[],"payload":{"tag":"li","lines":"62,63"}},{"content":"<strong>Port:</strong> From <code>PORT</code> env (e.g. 8080).","children":[],"payload":{"tag":"li","lines":"63,65"}}],"payload":{"tag":"li","lines":"57,65"}}],"payload":{"tag":"h3","lines":"55,56"}},{"content":"Flow (Tool Call)","children":[{"content":"1. Agent establishes SSE session to <code>MCP_SERVER_URL</code> (e.g. <code>https://mcp-server-xxx.run.app/sse</code>) with Bearer token.","children":[],"payload":{"tag":"li","lines":"67,68","listIndex":1}},{"content":"2. Agent sends MCP protocol messages over SSE.","children":[],"payload":{"tag":"li","lines":"68,69","listIndex":2}},{"content":"3. When the LLM decides to use a tool, the client sends a tools/call; server runs <code>get_exchange_rate</code> and returns result.","children":[],"payload":{"tag":"li","lines":"69,70","listIndex":3}},{"content":"4. Agent gets result and continues LLM flow.","children":[],"payload":{"tag":"li","lines":"70,72","listIndex":4}}],"payload":{"tag":"h3","lines":"65,66"}}],"payload":{"tag":"h2","lines":"50,51"}},{"content":"3. Authentication Between Agent and MCP Server","children":[{"content":"What It Is","children":[],"payload":{"tag":"h3","lines":"76,77"}},{"content":"Why","children":[{"content":"MCP server is deployed with <code>--no-allow-unauthenticated</code>, so every request must be authenticated.","children":[],"payload":{"tag":"li","lines":"80,81"}},{"content":"Cloud Run validates the <code>Authorization: Bearer &lt;id_token&gt;</code> and checks the token&#x2019;s audience and issuer.","children":[],"payload":{"tag":"li","lines":"81,83"}}],"payload":{"tag":"h3","lines":"79,80"}},{"content":"How It Works","children":[{"content":"1. <strong>Agent identity:</strong> Agent runs as a service account (e.g. <code>PROJECT_ID@appspot.gserviceaccount.com</code> or compute default).","children":[],"payload":{"tag":"li","lines":"85,86","listIndex":1}},{"content":"2. <strong>Token:</strong> <code>auth_helper.get_authenticated_headers(MCP_SERVER_URL)</code> uses ADC to get an ID token with audience = MCP service base URL (e.g. <code>https://mcp-server-xxx.run.app</code>).","children":[],"payload":{"tag":"li","lines":"86,87","listIndex":2}},{"content":"3. <strong>Request:</strong> MCP client (SSE) sends this header when connecting. Cloud Run in front of the MCP server validates the token and allows or denies the request.","children":[],"payload":{"tag":"li","lines":"87,88","listIndex":3}},{"content":"4. <strong>IAM:</strong> The agent&#x2019;s service account must have <code>roles/run.invoker</code> on the MCP server. Otherwise Cloud Run returns 403 even with a valid token.","children":[],"payload":{"tag":"li","lines":"88,90","listIndex":4}}],"payload":{"tag":"h3","lines":"83,84"}},{"content":"Roles Summary","children":[{"content":"<table data-lines=\"92,97\">\n<thead data-lines=\"92,93\">\n<tr data-lines=\"92,93\">\n<th>Role</th>\n<th>Where</th>\n<th>Who Has It</th>\n<th>Why</th>\n</tr>\n</thead>\n<tbody data-lines=\"94,97\">\n<tr data-lines=\"94,95\">\n<td><strong>roles/run.invoker</strong></td>\n<td>MCP server (Cloud Run resource)</td>\n<td>Agent&#x2019;s service account</td>\n<td>Allows agent to call the MCP Cloud Run service.</td>\n</tr>\n<tr data-lines=\"95,96\">\n<td><strong>roles/aiplatform.user</strong></td>\n<td>Project</td>\n<td>Agent&#x2019;s service account</td>\n<td>Allows agent to call Vertex AI (Gemini).</td>\n</tr>\n<tr data-lines=\"96,97\">\n<td>(Optional) <strong>roles/iam.serviceAccountUser</strong></td>\n<td>Agent&#x2019;s service account</td>\n<td>Your user</td>\n<td>So you can deploy the agent with that service account.</td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"92,97"}}],"payload":{"tag":"h3","lines":"90,91"}}],"payload":{"tag":"h2","lines":"74,75"}},{"content":"4. Data Flow: Input to Final Response","children":[{"content":"Step 1: User Input Reaches the Agent","children":[{"content":"<strong>Input:</strong> Client sends HTTP POST to the agent&#x2019;s <code>/chat</code> endpoint (e.g. <code>https://adk-agent-xxx.run.app/chat</code>).","children":[],"payload":{"tag":"li","lines":"106,107"}},{"content":"<strong>Payload (example):</strong> <code>{&quot;message&quot;: &quot;What is 100 USD in EUR?&quot;, &quot;session_id&quot;: &quot;test-1&quot;, &quot;user_id&quot;: &quot;user-1&quot;}</code>.","children":[],"payload":{"tag":"li","lines":"107,108"}},{"content":"<strong>Who receives it:</strong> The <strong>ADK Agent</strong> Cloud Run service (FastAPI in <code>main.py</code>).","children":[],"payload":{"tag":"li","lines":"108,109"}},{"content":"<strong>Auth at this step:</strong> None required if the agent is deployed with <code>--allow-unauthenticated</code>. If the agent were private, the client would need to send a Bearer ID token; Cloud Run would validate it.","children":[],"payload":{"tag":"li","lines":"109,111"}}],"payload":{"tag":"h3","lines":"104,105"}},{"content":"Step 2: Agent Service Handles the Request","children":[{"content":"<strong>main.py</strong> receives the request.","children":[],"payload":{"tag":"li","lines":"113,114"}},{"content":"<strong>Session:</strong> Looks up or creates a session for <code>(app_name, user_id, session_id)</code> via <code>InMemorySessionService</code> so the runner has a valid session.","children":[],"payload":{"tag":"li","lines":"114,115"}},{"content":"<strong>Runner:</strong> Calls <code>runner.run_async(user_id, session_id, new_message)</code> with the user message as <code>Content(role=&apos;user&apos;, parts=[...])</code>.","children":[],"payload":{"tag":"li","lines":"115,116"}},{"content":"<strong>No external call yet:</strong> Everything so far is inside the agent container.","children":[],"payload":{"tag":"li","lines":"116,118"}}],"payload":{"tag":"h3","lines":"111,112"}},{"content":"Step 3: Agent Needs MCP Tools &#x2192; Authentication Flow Starts","children":[{"content":"<strong>Runner</strong> starts the <strong>LlmAgent</strong> (Gemini) with the message.","children":[],"payload":{"tag":"li","lines":"120,121"}},{"content":"<strong>LLM</strong> may decide to use a tool (e.g. <code>get_exchange_rate</code>). The agent&#x2019;s <strong>MCPToolset</strong> must then talk to the MCP server.","children":[],"payload":{"tag":"li","lines":"121,122"}},{"content":"<strong>MCP client (in agent)</strong> opens a session to <code>MCP_SERVER_URL</code> (e.g. <code>https://mcp-server-xxx.run.app/sse</code>).","children":[{"content":"<strong>header_provider</strong> is invoked: agent code calls <code>get_mcp_headers(context)</code>.","children":[],"payload":{"tag":"li","lines":"123,124"}},{"content":"<strong>auth_helper.get_authenticated_headers(MCP_SERVER_URL)</strong> runs:","children":[{"content":"Parses <code>MCP_SERVER_URL</code> &#x2192; base URL (e.g. <code>https://mcp-server-xxx.run.app</code>).","children":[],"payload":{"tag":"li","lines":"125,126"}},{"content":"Calls <strong>get_id_token(audience=base_url)</strong>.","children":[],"payload":{"tag":"li","lines":"126,127"}},{"content":"<strong>get_id_token</strong> uses <strong>Application Default Credentials</strong> (ADC): on Cloud Run, the container runs as a <strong>service account</strong>; ADC provides that identity.","children":[],"payload":{"tag":"li","lines":"127,128"}},{"content":"<strong>google.oauth2.id_token.fetch_id_token(request, audience)</strong> returns an <strong>OIDC ID token</strong> for that audience.","children":[],"payload":{"tag":"li","lines":"128,129"}}],"payload":{"tag":"li","lines":"124,129"}},{"content":"Returns <code>{&quot;Authorization&quot;: &quot;Bearer &lt;id_token&gt;&quot;}</code> to the MCP client.","children":[],"payload":{"tag":"li","lines":"129,130"}}],"payload":{"tag":"li","lines":"122,130"}},{"content":"<strong>MCP client</strong> connects to the MCP server&#x2019;s SSE endpoint with this <code>Authorization</code> header.","children":[],"payload":{"tag":"li","lines":"130,132"}}],"payload":{"tag":"h3","lines":"118,119"}},{"content":"Step 4: MCP Server Receives the Request (Auth Check by Cloud Run)","children":[{"content":"<strong>Request:</strong> From the agent&#x2019;s container to the MCP server&#x2019;s public URL (e.g. <code>https://mcp-server-xxx.run.app/sse</code>), including <code>Authorization: Bearer &lt;id_token&gt;</code>.","children":[],"payload":{"tag":"li","lines":"134,135"}},{"content":"<strong>Who validates auth:</strong> <strong>Cloud Run</strong> (the MCP server&#x2019;s front proxy), not the app code.","children":[{"content":"Cloud Run checks the ID token: signature, audience (must match MCP service URL), expiry, issuer.","children":[],"payload":{"tag":"li","lines":"136,137"}},{"content":"Cloud Run checks <strong>IAM:</strong> the token&#x2019;s subject (the agent&#x2019;s <strong>service account</strong>) must have <strong>roles/run.invoker</strong> on the <strong>mcp-server</strong> Cloud Run service. If not &#x2192; <strong>403 Forbidden</strong>.","children":[],"payload":{"tag":"li","lines":"137,138"}}],"payload":{"tag":"li","lines":"135,138"}},{"content":"<strong>If auth passes:</strong> Request is forwarded to the MCP server container (FastMCP). The app code does not see the token; it just handles MCP protocol.","children":[],"payload":{"tag":"li","lines":"138,140"}}],"payload":{"tag":"h3","lines":"132,133"}},{"content":"Step 5: MCP Protocol and Tool Execution","children":[{"content":"<strong>MCP server</strong> (FastMCP) receives MCP messages over the SSE connection.","children":[],"payload":{"tag":"li","lines":"142,143"}},{"content":"<strong>Tools/list</strong> (if needed): Server returns available tools (e.g. <code>get_exchange_rate</code>).","children":[],"payload":{"tag":"li","lines":"143,144"}},{"content":"<strong>Tools/call:</strong> When the LLM asks for a rate, the client sends a tool call; server runs <strong>get_exchange_rate(currency_from=&quot;USD&quot;, currency_to=&quot;EUR&quot;, ...)</strong>.","children":[],"payload":{"tag":"li","lines":"144,145"}},{"content":"<strong>get_exchange_rate</strong> in <strong>server.py</strong> calls the <strong>Frankfurter API</strong> (external HTTP), then returns the result in MCP format to the client.","children":[],"payload":{"tag":"li","lines":"145,146"}},{"content":"<strong>Agent</strong> receives the tool result and passes it back into the <strong>LLM</strong> (Gemini).","children":[],"payload":{"tag":"li","lines":"146,148"}}],"payload":{"tag":"h3","lines":"140,141"}},{"content":"Step 6: LLM and Vertex AI (Agent &#x2192; Vertex)","children":[{"content":"<strong>Agent</strong> sends the conversation (user message + tool result) to <strong>Vertex AI (Gemini)</strong> for the next turn.","children":[],"payload":{"tag":"li","lines":"150,151"}},{"content":"<strong>Auth:</strong> The agent uses ADC again (same service account). Vertex AI checks that the caller has <strong>roles/aiplatform.user</strong> on the <strong>project</strong>. No token is sent in the doc; the client library uses ADC under the hood.","children":[],"payload":{"tag":"li","lines":"151,152"}},{"content":"<strong>Response:</strong> Gemini returns the model reply (e.g. &#x201c;100 USD is 84.56 EUR.&#x201d;).","children":[],"payload":{"tag":"li","lines":"152,154"}}],"payload":{"tag":"h3","lines":"148,149"}},{"content":"Step 7: Agent Collects Response and Returns to Client","children":[{"content":"<strong>Runner</strong> streams events back; <strong>main.py</strong> collects content from events (e.g. <code>event.content.parts[].text</code>).","children":[],"payload":{"tag":"li","lines":"156,157"}},{"content":"<strong>Response body:</strong> <code>{&quot;response&quot;: &quot;100 USD is 84.56 EUR.&quot;, &quot;session_id&quot;: &quot;test-1&quot;}</code>.","children":[],"payload":{"tag":"li","lines":"157,158"}},{"content":"<strong>HTTP:</strong> FastAPI returns 200 and this JSON to the original client.","children":[],"payload":{"tag":"li","lines":"158,160"}}],"payload":{"tag":"h3","lines":"154,155"}},{"content":"Data Flow Summary (Services and Roles)","children":[{"content":"<table data-lines=\"162,171\">\n<thead data-lines=\"162,163\">\n<tr data-lines=\"162,163\">\n<th>Step</th>\n<th>From</th>\n<th>To</th>\n<th>What happens</th>\n<th>Role / auth</th>\n</tr>\n</thead>\n<tbody data-lines=\"164,171\">\n<tr data-lines=\"164,165\">\n<td>1</td>\n<td>Client</td>\n<td>ADK Agent (Cloud Run)</td>\n<td>POST /chat with message</td>\n<td>Optional: caller auth if agent is private</td>\n</tr>\n<tr data-lines=\"165,166\">\n<td>2</td>\n<td>main.py</td>\n<td>Runner / Agent</td>\n<td>Session + run_async</td>\n<td>None</td>\n</tr>\n<tr data-lines=\"166,167\">\n<td>3</td>\n<td>Agent (MCP client)</td>\n<td>auth_helper</td>\n<td>Get ID token for MCP URL</td>\n<td>ADC = agent&#x2019;s service account</td>\n</tr>\n<tr data-lines=\"167,168\">\n<td>4</td>\n<td>Agent</td>\n<td>MCP Server (Cloud Run)</td>\n<td>SSE connection with Bearer token</td>\n<td><strong>roles/run.invoker</strong> on mcp-server (agent SA)</td>\n</tr>\n<tr data-lines=\"168,169\">\n<td>5</td>\n<td>MCP server</td>\n<td>Frankfurter API</td>\n<td>get_exchange_rate HTTP call</td>\n<td>None (public API)</td>\n</tr>\n<tr data-lines=\"169,170\">\n<td>6</td>\n<td>Agent</td>\n<td>Vertex AI (Gemini)</td>\n<td>LLM request</td>\n<td><strong>roles/aiplatform.user</strong> on project (agent SA)</td>\n</tr>\n<tr data-lines=\"170,171\">\n<td>7</td>\n<td>Agent</td>\n<td>Client</td>\n<td>JSON response</td>\n<td>None</td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"162,171"}}],"payload":{"tag":"h3","lines":"160,161"}},{"content":"Diagram (Linear)","children":[{"content":"<pre data-lines=\"174,199\"><code data-lines=\"174,199\">[<span class=\"hljs-meta\">Client</span>]\n   | POST /chat { message, session_id, user_id }\n   v\n[<span class=\"hljs-meta\">ADK Agent - Cloud Run</span>]\n   | main.py: session <span class=\"hljs-keyword\">get</span>/create, runner.run_async\n   v\n[<span class=\"hljs-meta\">LlmAgent</span>] --&gt; needs tool? --&gt; [header_provider] --&gt; [auth_helper: get_id_token(MCP <span class=\"hljs-keyword\">base</span> URL)]\n   |                                                    | ADC &#x2192; ID token\n   |                                                    v\n   | MCP client connects to MCP_SERVER_URL/sse <span class=\"hljs-keyword\">with</span> Authorization: Bearer &lt;token&gt;\n   v\n[<span class=\"hljs-meta\">MCP Server - Cloud Run</span>]\n   | Cloud Run validates token + IAM (run.invoker <span class=\"hljs-keyword\">for</span> agent SA)\n   v\n[<span class=\"hljs-meta\">FastMCP</span>] --&gt; tools/call get_exchange_rate --&gt; [Frankfurter API] --&gt; result\n   |\n   v result back to agent\n[<span class=\"hljs-meta\">LlmAgent</span>] --&gt; [Vertex AI / Gemini]  (ADC, roles/aiplatform.user)\n   |\n   v model reply\n[<span class=\"hljs-meta\">main.py</span>] --&gt; collect events --&gt; JSON { response, session_id }\n   v\n[<span class=\"hljs-meta\">Client</span>]\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"174,199"}}],"payload":{"tag":"h3","lines":"172,173"}}],"payload":{"tag":"h2","lines":"100,101"}},{"content":"5. Dockerfiles (What &amp; Why)","children":[{"content":"ADK Agent Dockerfile","children":[{"content":"<strong>Base image:</strong> <code>python:3.12-slim</code>","children":[{"content":"<strong>What:</strong> Official slim Python 3.12 image.","children":[],"payload":{"tag":"li","lines":"207,208"}},{"content":"<strong>Why:</strong> 3.12 has better async/task context behavior; helps avoid certain MCP/AnyIO issues; keeps image smaller than full Python image.","children":[],"payload":{"tag":"li","lines":"208,209"}}],"payload":{"tag":"li","lines":"206,209"}},{"content":"<strong>WORKDIR /app:</strong> All app code and run context live here.","children":[],"payload":{"tag":"li","lines":"209,210"}},{"content":"<strong>COPY requirements.txt</strong> then <strong>RUN pip install</strong>","children":[{"content":"<strong>What:</strong> Install dependencies before copying code.","children":[],"payload":{"tag":"li","lines":"211,212"}},{"content":"<strong>Why:</strong> Better layer caching; code changes don&#x2019;t invalidate the dependency layer.","children":[],"payload":{"tag":"li","lines":"212,213"}}],"payload":{"tag":"li","lines":"210,213"}},{"content":"<strong>COPY agent.py main.py auth_helper.py</strong>","children":[{"content":"<strong>What:</strong> Application code.","children":[],"payload":{"tag":"li","lines":"214,215"}},{"content":"<strong>Why:</strong> Agent, FastAPI app, and auth helper must be in the image.","children":[],"payload":{"tag":"li","lines":"215,216"}}],"payload":{"tag":"li","lines":"213,216"}},{"content":"<strong>EXPOSE 8080:</strong> Documents that the app listens on 8080; Cloud Run still sets <code>PORT</code>.","children":[],"payload":{"tag":"li","lines":"216,217"}},{"content":"<strong>CMD [&quot;python&quot;, &quot;main.py&quot;]:</strong> Starts the FastAPI app (uvicorn inside main).","children":[],"payload":{"tag":"li","lines":"217,219"}}],"payload":{"tag":"h3","lines":"204,205"}},{"content":"MCP Server Dockerfile","children":[{"content":"<strong>Base image:</strong> <code>python:3.11-slim</code>","children":[{"content":"<strong>What:</strong> Slim Python 3.11 image.","children":[],"payload":{"tag":"li","lines":"222,223"}},{"content":"<strong>Why:</strong> Smaller image; MCP server is simple and doesn&#x2019;t need 3.12 for the same reasons as the agent.","children":[],"payload":{"tag":"li","lines":"223,224"}}],"payload":{"tag":"li","lines":"221,224"}},{"content":"<strong>COPY requirements.txt</strong> then <strong>RUN pip install</strong>","children":[{"content":"<strong>What:</strong> Install fastmcp, httpx, etc.","children":[],"payload":{"tag":"li","lines":"225,226"}},{"content":"<strong>Why:</strong> Same caching benefit as agent.","children":[],"payload":{"tag":"li","lines":"226,227"}}],"payload":{"tag":"li","lines":"224,227"}},{"content":"<strong>COPY server.py:</strong> Only app file.","children":[],"payload":{"tag":"li","lines":"227,228"}},{"content":"<strong>EXPOSE 8080:</strong> Cloud Run sets <code>PORT</code>; default 8080 for local consistency.","children":[],"payload":{"tag":"li","lines":"228,229"}},{"content":"<strong>CMD [&quot;python&quot;, &quot;server.py&quot;]:</strong> Starts FastMCP with <code>transport=&quot;sse&quot;</code>.","children":[],"payload":{"tag":"li","lines":"229,231"}}],"payload":{"tag":"h3","lines":"219,220"}}],"payload":{"tag":"h2","lines":"202,203"}},{"content":"6. Onboarding: From Google Auth to Deployed Services","children":[{"content":"5.1 Google Auth (What &amp; Why)","children":[{"content":"<strong>gcloud auth login</strong>","children":[{"content":"<strong>What:</strong> Interactive login for your user account.","children":[],"payload":{"tag":"li","lines":"238,239"}},{"content":"<strong>Why:</strong> Needed to use gcloud and to deploy (build, deploy, IAM).","children":[],"payload":{"tag":"li","lines":"239,240"}}],"payload":{"tag":"li","lines":"237,240"}},{"content":"<strong>gcloud config set project PROJECT_ID</strong>","children":[{"content":"<strong>What:</strong> Sets default project for gcloud commands.","children":[],"payload":{"tag":"li","lines":"241,242"}},{"content":"<strong>Why:</strong> All deploy and IAM commands target this project.","children":[],"payload":{"tag":"li","lines":"242,243"}}],"payload":{"tag":"li","lines":"240,243"}},{"content":"<strong>gcloud auth application-default login</strong>","children":[{"content":"<strong>What:</strong> Writes Application Default Credentials (ADC) for your user to a well-known path.","children":[],"payload":{"tag":"li","lines":"244,245"}},{"content":"<strong>Why:</strong> Agent and scripts that use client libraries (e.g. Vertex AI, ID token) use ADC when no explicit key is set. Required for local runs and for Cloud Build/service accounts that assume your identity during setup.","children":[],"payload":{"tag":"li","lines":"245,247"}}],"payload":{"tag":"li","lines":"243,247"}}],"payload":{"tag":"h3","lines":"235,236"}},{"content":"5.2 Enable APIs (What &amp; Why)","children":[{"content":"<strong>Cloud Run API</strong> (e.g. run.googleapis.com or cloudrun.googleapis.com)","children":[{"content":"<strong>What:</strong> Enables deploying and running services on Cloud Run.","children":[],"payload":{"tag":"li","lines":"250,251"}},{"content":"<strong>Why:</strong> Both agent and MCP server are Cloud Run services.","children":[],"payload":{"tag":"li","lines":"251,252"}}],"payload":{"tag":"li","lines":"249,252"}},{"content":"<strong>Cloud Build API</strong>","children":[{"content":"<strong>What:</strong> Builds container images from Dockerfile and pushes to the registry.","children":[],"payload":{"tag":"li","lines":"253,254"}},{"content":"<strong>Why:</strong> <code>gcloud builds submit</code> uses Cloud Build.","children":[],"payload":{"tag":"li","lines":"254,255"}}],"payload":{"tag":"li","lines":"252,255"}},{"content":"<strong>Vertex AI API</strong> (aiplatform.googleapis.com)","children":[{"content":"<strong>What:</strong> Enables use of Gemini (and other Vertex models).","children":[],"payload":{"tag":"li","lines":"256,257"}},{"content":"<strong>Why:</strong> Agent uses Vertex AI for the LLM.","children":[],"payload":{"tag":"li","lines":"257,258"}}],"payload":{"tag":"li","lines":"255,258"}},{"content":"<strong>Artifact Registry / Container Registry</strong>","children":[{"content":"<strong>What:</strong> Stores built images (e.g. gcr.io or Artifact Registry).","children":[],"payload":{"tag":"li","lines":"259,260"}},{"content":"<strong>Why:</strong> Cloud Run runs images from a registry.","children":[],"payload":{"tag":"li","lines":"260,262"}}],"payload":{"tag":"li","lines":"258,262"}}],"payload":{"tag":"h3","lines":"247,248"}},{"content":"5.3 Create / Use Service Accounts","children":[{"content":"<strong>Default compute or appspot account</strong>","children":[{"content":"<strong>What:</strong> e.g. <code>PROJECT_NUMBER-compute@developer.gserviceaccount.com</code> or <code>PROJECT_ID@appspot.gserviceaccount.com</code>.","children":[],"payload":{"tag":"li","lines":"265,266"}},{"content":"<strong>Why:</strong> Cloud Run can run as this identity; we grant it <code>roles/run.invoker</code> on MCP and <code>roles/aiplatform.user</code> on the project.","children":[],"payload":{"tag":"li","lines":"266,267"}}],"payload":{"tag":"li","lines":"264,267"}},{"content":"<strong>No extra &#x201c;creation&#x201d; step</strong> if you use the default; deployment creates or uses it.","children":[],"payload":{"tag":"li","lines":"267,269"}}],"payload":{"tag":"h3","lines":"262,263"}},{"content":"5.4 Deploy MCP Server","children":[{"content":"Build image (e.g. from mcp-server directory): <code>gcloud builds submit --tag gcr.io/PROJECT_ID/mcp-server</code>","children":[{"content":"<strong>What:</strong> Builds the MCP server Docker image and pushes it.","children":[],"payload":{"tag":"li","lines":"272,273"}},{"content":"<strong>Why:</strong> Cloud Run needs an image in the project&#x2019;s registry.","children":[],"payload":{"tag":"li","lines":"273,274"}}],"payload":{"tag":"li","lines":"271,274"}},{"content":"Deploy: <code>gcloud run deploy mcp-server --image gcr.io/PROJECT_ID/mcp-server --no-allow-unauthenticated ...</code>","children":[{"content":"<strong>What:</strong> Creates/updates the MCP Cloud Run service, private (auth required).","children":[],"payload":{"tag":"li","lines":"275,276"}},{"content":"<strong>Why:</strong> So only the agent (with valid ID token and run.invoker) can call it.","children":[],"payload":{"tag":"li","lines":"276,277"}}],"payload":{"tag":"li","lines":"274,277"}},{"content":"Get URL: <code>gcloud run services describe mcp-server --format &apos;value(status.url)&apos;</code>","children":[{"content":"<strong>What:</strong> Base URL of the service (e.g. <code>https://mcp-server-xxx.run.app</code>).","children":[],"payload":{"tag":"li","lines":"278,279"}},{"content":"<strong>Why:</strong> Agent needs <code>MCP_SERVER_URL = base_url + &quot;/sse&quot;</code>.","children":[],"payload":{"tag":"li","lines":"279,281"}}],"payload":{"tag":"li","lines":"277,281"}}],"payload":{"tag":"h3","lines":"269,270"}},{"content":"5.5 Set MCP_SERVER_URL and Deploy Agent","children":[{"content":"Export: <code>export MCP_SERVER_URL=https://mcp-server-xxx.run.app/sse</code> (example only).","children":[],"payload":{"tag":"li","lines":"283,284"}},{"content":"Deploy agent: run deploy script or <code>gcloud run deploy adk-agent ... --set-env-vars MCP_SERVER_URL=...,GOOGLE_GENAI_USE_VERTEXAI=TRUE,...</code>","children":[{"content":"<strong>What:</strong> Builds and deploys the agent with env vars.","children":[],"payload":{"tag":"li","lines":"285,286"}},{"content":"<strong>Why:</strong> Agent must know where the MCP server is and that it uses Vertex AI.","children":[],"payload":{"tag":"li","lines":"286,288"}}],"payload":{"tag":"li","lines":"284,288"}}],"payload":{"tag":"h3","lines":"281,282"}},{"content":"5.6 IAM: Agent &#x2192; MCP and Vertex","children":[{"content":"<strong>Grant run.invoker on MCP server to agent&#x2019;s service account</strong>","children":[{"content":"<strong>What:</strong> <code>gcloud run services add-iam-policy-binding mcp-server --member=&quot;serviceAccount:AGENT_SA&quot; --role=&quot;roles/run.invoker&quot; ...</code>","children":[],"payload":{"tag":"li","lines":"291,292"}},{"content":"<strong>Why:</strong> Without this, MCP server returns 403 to the agent.","children":[],"payload":{"tag":"li","lines":"292,293"}}],"payload":{"tag":"li","lines":"290,293"}},{"content":"<strong>Grant aiplatform.user on project to agent&#x2019;s service account</strong>","children":[{"content":"<strong>What:</strong> <code>gcloud projects add-iam-policy-binding PROJECT_ID --member=&quot;serviceAccount:AGENT_SA&quot; --role=&quot;roles/aiplatform.user&quot;</code>","children":[],"payload":{"tag":"li","lines":"294,295"}},{"content":"<strong>Why:</strong> Agent needs this to call Vertex AI (Gemini).","children":[],"payload":{"tag":"li","lines":"295,297"}}],"payload":{"tag":"li","lines":"293,297"}}],"payload":{"tag":"h3","lines":"288,289"}}],"payload":{"tag":"h2","lines":"233,234"}},{"content":"7. All Commands (Reference Only &#x2014; Use Example Values)","children":[{"content":"Auth and project","children":[{"content":"<pre data-lines=\"303,308\"><code class=\"language-bash\">gcloud auth login\ngcloud config <span class=\"hljs-built_in\">set</span> project YOUR_PROJECT_ID\ngcloud auth application-default login\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"303,308"}}],"payload":{"tag":"h3","lines":"301,302"}},{"content":"APIs","children":[{"content":"<pre data-lines=\"311,317\"><code class=\"language-bash\">gcloud services <span class=\"hljs-built_in\">enable</span> run.googleapis.com --project YOUR_PROJECT_ID\ngcloud services <span class=\"hljs-built_in\">enable</span> cloudbuild.googleapis.com --project YOUR_PROJECT_ID\ngcloud services <span class=\"hljs-built_in\">enable</span> aiplatform.googleapis.com --project YOUR_PROJECT_ID\ngcloud services <span class=\"hljs-built_in\">enable</span> artifactregistry.googleapis.com --project YOUR_PROJECT_ID\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"311,317"}}],"payload":{"tag":"h3","lines":"309,310"}},{"content":"MCP server deploy","children":[{"content":"<pre data-lines=\"320,325\"><code class=\"language-bash\"><span class=\"hljs-built_in\">cd</span> cloud-run-deployment/mcp-server\ngcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/mcp-server --project YOUR_PROJECT_ID\ngcloud run deploy mcp-server --image gcr.io/YOUR_PROJECT_ID/mcp-server --platform managed --region REGION --no-allow-unauthenticated --memory 512Mi --cpu 1 --<span class=\"hljs-built_in\">timeout</span> 300 --max-instances 10 --project YOUR_PROJECT_ID\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"320,325"}}],"payload":{"tag":"h3","lines":"318,319"}},{"content":"Get MCP URL and set for agent","children":[{"content":"<pre data-lines=\"328,332\"><code class=\"language-bash\">MCP_SERVER_URL=&#x24;(gcloud run services describe mcp-server --platform managed --region REGION --project YOUR_PROJECT_ID --format <span class=\"hljs-string\">&apos;value(status.url)&apos;</span>)\n<span class=\"hljs-built_in\">export</span> MCP_SERVER_URL=<span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">&#x24;{MCP_SERVER_URL}</span>/sse&quot;</span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"328,332"}}],"payload":{"tag":"h3","lines":"326,327"}},{"content":"Agent deploy","children":[{"content":"<pre data-lines=\"335,340\"><code class=\"language-bash\"><span class=\"hljs-built_in\">cd</span> cloud-run-deployment/adk-agent\ngcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/adk-agent --project YOUR_PROJECT_ID\ngcloud run deploy adk-agent --image gcr.io/YOUR_PROJECT_ID/adk-agent --platform managed --region REGION --allow-unauthenticated --set-env-vars <span class=\"hljs-string\">&quot;GOOGLE_CLOUD_PROJECT=YOUR_PROJECT_ID,GOOGLE_CLOUD_LOCATION=REGION,GOOGLE_GENAI_USE_VERTEXAI=TRUE,MCP_SERVER_URL=<span class=\"hljs-variable\">&#x24;{MCP_SERVER_URL}</span>,GOOGLE_MODEL=gemini-2.5-flash&quot;</span> ... --project YOUR_PROJECT_ID\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"335,340"}}],"payload":{"tag":"h3","lines":"333,334"}},{"content":"IAM (agent &#x2192; MCP)","children":[{"content":"<pre data-lines=\"343,347\"><code class=\"language-bash\"><span class=\"hljs-comment\"># Use the same REGION and YOUR_PROJECT_ID; AGENT_SA = service account used by adk-agent</span>\ngcloud run services add-iam-policy-binding mcp-server --member=<span class=\"hljs-string\">&quot;serviceAccount:AGENT_SA&quot;</span> --role=<span class=\"hljs-string\">&quot;roles/run.invoker&quot;</span> --region REGION --project YOUR_PROJECT_ID\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"343,347"}}],"payload":{"tag":"h3","lines":"341,342"}},{"content":"IAM (Vertex AI)","children":[{"content":"<pre data-lines=\"350,353\"><code class=\"language-bash\">gcloud projects add-iam-policy-binding YOUR_PROJECT_ID --member=<span class=\"hljs-string\">&quot;serviceAccount:AGENT_SA&quot;</span> --role=<span class=\"hljs-string\">&quot;roles/aiplatform.user&quot;</span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"350,353"}}],"payload":{"tag":"h3","lines":"348,349"}},{"content":"Test (example only)","children":[{"content":"<pre data-lines=\"356,359\"><code class=\"language-bash\">curl -X POST https://adk-agent-xxx.run.app/chat -H <span class=\"hljs-string\">&apos;Content-Type: application/json&apos;</span> -d <span class=\"hljs-string\">&apos;{&quot;message&quot;: &quot;What is 100 USD in EUR?&quot;, &quot;session_id&quot;: &quot;test-1&quot;, &quot;user_id&quot;: &quot;test-user&quot;}&apos;</span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"356,359"}}],"payload":{"tag":"h3","lines":"354,355"}}],"payload":{"tag":"h2","lines":"299,300"}},{"content":"8. HTTP Stream (Streamable HTTP) vs SSE","children":[{"content":"What Is Streamable HTTP (HTTP Stream)","children":[{"content":"<strong>What:</strong> MCP transport where client and server exchange a long-lived HTTP request/response (or bidirectional stream) and send MCP messages over it.","children":[],"payload":{"tag":"li","lines":"366,367"}},{"content":"<strong>Why used:</strong> One of the standard MCP remote transports; efficient for some clients.","children":[],"payload":{"tag":"li","lines":"367,368"}},{"content":"<strong>In ADK:</strong> Implemented via <code>StreamableHTTPConnectionParams</code>; client uses a streamable HTTP connection to the MCP server endpoint (e.g. <code>/mcp</code>).","children":[],"payload":{"tag":"li","lines":"368,370"}}],"payload":{"tag":"h3","lines":"364,365"}},{"content":"What Is SSE (Server-Sent Events)","children":[{"content":"<strong>What:</strong> HTTP-based, one-way stream: server sends events (text/event-stream) to the client; client sends requests (e.g. POST) for new operations. MCP can run on top of this.","children":[],"payload":{"tag":"li","lines":"372,373"}},{"content":"<strong>Why used:</strong> Simpler async model in some environments; single long-lived response from server; avoids some bidirectional streaming issues.","children":[],"payload":{"tag":"li","lines":"373,374"}},{"content":"<strong>In ADK:</strong> Implemented via <code>SseConnectionParams</code>; endpoint is typically <code>/sse</code>. FastMCP supports <code>transport=&quot;sse&quot;</code>.","children":[],"payload":{"tag":"li","lines":"374,376"}}],"payload":{"tag":"h3","lines":"370,371"}},{"content":"Differences (Short)","children":[{"content":"<table data-lines=\"378,385\">\n<thead data-lines=\"378,379\">\n<tr data-lines=\"378,379\">\n<th>Aspect</th>\n<th>Streamable HTTP</th>\n<th>SSE</th>\n</tr>\n</thead>\n<tbody data-lines=\"380,385\">\n<tr data-lines=\"380,381\">\n<td>Direction</td>\n<td>Bidirectional stream over HTTP</td>\n<td>Server pushes events; client uses separate requests</td>\n</tr>\n<tr data-lines=\"381,382\">\n<td>Endpoint</td>\n<td>Often <code>/mcp</code></td>\n<td>Often <code>/sse</code></td>\n</tr>\n<tr data-lines=\"382,383\">\n<td>Connection params</td>\n<td>StreamableHTTPConnectionParams</td>\n<td>SseConnectionParams</td>\n</tr>\n<tr data-lines=\"383,384\">\n<td>Async context</td>\n<td>Can trigger cancel-scope/task-boundary issues in some runtimes</td>\n<td>Different code path; can avoid those issues</td>\n</tr>\n<tr data-lines=\"384,385\">\n<td>Auth</td>\n<td>Same (e.g. Bearer ID token)</td>\n<td>Same</td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"378,385"}}],"payload":{"tag":"h3","lines":"376,377"}},{"content":"Why We Switched to SSE","children":[{"content":"With Streamable HTTP on Cloud Run we hit: &#x201c;Attempted to exit cancel scope in a different task than it was entered in&#x201d; (AnyIO/task boundaries).","children":[],"payload":{"tag":"li","lines":"388,389"}},{"content":"Switching to SSE uses a different client path and avoids that failure while keeping the same auth and IAM.","children":[],"payload":{"tag":"li","lines":"389,391"}}],"payload":{"tag":"h3","lines":"386,387"}}],"payload":{"tag":"h2","lines":"362,363"}},{"content":"9. Issue We Hit (Cancel Scope / TaskGroup)","children":[{"content":"What Happened","children":[{"content":"<strong>Symptom:</strong> Agent on Cloud Run failed to create MCP session with errors like &#x201c;unhandled errors in a TaskGroup&#x201d; and &#x201c;Attempted to exit cancel scope in a different task than it was entered in&#x201d;.","children":[],"payload":{"tag":"li","lines":"397,398"}},{"content":"<strong>Where:</strong> MCP client code using Streamable HTTP; AnyIO cancel scope entered in one asyncio task and exited in another when running in Cloud Run&#x2019;s request context.","children":[],"payload":{"tag":"li","lines":"398,399"}},{"content":"<strong>Why:</strong> Cloud Run&#x2019;s request lifecycle and the way the runner/MCP client start tasks don&#x2019;t align with AnyIO&#x2019;s expectations for that transport.","children":[],"payload":{"tag":"li","lines":"399,401"}}],"payload":{"tag":"h3","lines":"395,396"}},{"content":"What We Did","children":[{"content":"<strong>Python 3.12:</strong> Improved async context; issue persisted with Streamable HTTP.","children":[],"payload":{"tag":"li","lines":"403,404"}},{"content":"<strong>Dynamic auth:</strong> Switched to <code>header_provider</code> so ID token is fetched when the connection is established; fixed auth, not the crash.","children":[],"payload":{"tag":"li","lines":"404,405"}},{"content":"<strong>Session and runner:</strong> Ensured session exists and runner has <code>app_name</code>; fixed &#x201c;Session not found&#x201d;, not the crash.","children":[],"payload":{"tag":"li","lines":"405,406"}},{"content":"<strong>Workaround:</strong> Use <strong>SSE</strong> instead of Streamable HTTP (<code>SseConnectionParams</code>, MCP server with <code>transport=&quot;sse&quot;</code>). Same auth and IAM; different transport path that doesn&#x2019;t hit the cancel-scope bug.","children":[],"payload":{"tag":"li","lines":"406,408"}}],"payload":{"tag":"h3","lines":"401,402"}},{"content":"Doc","children":[{"content":"See <strong>KNOWN_ISSUES.md</strong> in this repo for full description, stack trace, and references.","children":[],"payload":{"tag":"li","lines":"410,412"}}],"payload":{"tag":"h3","lines":"408,409"}}],"payload":{"tag":"h2","lines":"393,394"}},{"content":"10. Cleanup Process and Scripts","children":[{"content":"What Cleanup Does","children":[{"content":"Removes Cloud Run services (adk-agent, mcp-server) so no more compute or request charges.","children":[],"payload":{"tag":"li","lines":"418,419"}},{"content":"Optionally deletes container images from the registry (saves a small storage cost).","children":[],"payload":{"tag":"li","lines":"419,420"}},{"content":"Optionally removes IAM bindings (run.invoker on mcp-server, aiplatform.user on project) so the project is back to a clean state.","children":[],"payload":{"tag":"li","lines":"420,422"}}],"payload":{"tag":"h3","lines":"416,417"}},{"content":"Script: cleanup.sh","children":[{"content":"<strong>Location:</strong> <code>cloud-run-deployment/scripts/cleanup.sh</code>","children":[],"payload":{"tag":"li","lines":"424,425"}},{"content":"<strong>Requires:</strong> <code>GOOGLE_CLOUD_PROJECT</code> (and optionally <code>GOOGLE_CLOUD_REGION</code>) set; no real URLs or project IDs in the script, use env.","children":[],"payload":{"tag":"li","lines":"425,426"}},{"content":"<strong>Steps:</strong>","children":[{"content":"1. Asks for confirmation (&#x201c;yes&#x201d;) before deleting.","children":[],"payload":{"tag":"li","lines":"427,428","listIndex":1}},{"content":"2. Deletes Cloud Run services: <code>adk-agent</code>, <code>mcp-server</code>.","children":[],"payload":{"tag":"li","lines":"428,429","listIndex":2}},{"content":"3. Deletes container images: e.g. <code>gcr.io/PROJECT_ID/adk-agent</code>, <code>gcr.io/PROJECT_ID/mcp-server</code>.","children":[],"payload":{"tag":"li","lines":"429,430","listIndex":3}},{"content":"4. Asks whether to remove IAM bindings; if yes, removes <code>roles/aiplatform.user</code> from project and <code>roles/run.invoker</code> from mcp-server for the service account used.","children":[],"payload":{"tag":"li","lines":"430,431","listIndex":4}}],"payload":{"tag":"li","lines":"426,431"}},{"content":"<strong>Note:</strong> Does not disable APIs; documents how to disable Cloud Run, Vertex AI, Cloud Build if desired.","children":[],"payload":{"tag":"li","lines":"431,433"}}],"payload":{"tag":"h3","lines":"422,423"}},{"content":"Retaining for Fast Restart","children":[{"content":"<strong>Keep images and IAM:</strong> Don&#x2019;t run the image-delete steps; don&#x2019;t remove IAM. Then you only delete the two Cloud Run services. Cost when &#x201c;stopped&#x201d;: ~&#x24;0 for compute; small storage for images. To restart: redeploy MCP server, set <code>MCP_SERVER_URL</code>, redeploy agent (same images and IAM).","children":[],"payload":{"tag":"li","lines":"435,436"}},{"content":"<strong>Full cleanup:</strong> Run cleanup.sh and choose to remove IAM and delete images when prompted. Re-onboarding later: auth, APIs, deploy MCP, set URL, deploy agent, IAM again.","children":[],"payload":{"tag":"li","lines":"436,438"}}],"payload":{"tag":"h3","lines":"433,434"}}],"payload":{"tag":"h2","lines":"414,415"}},{"content":"11. Summary Diagram (Conceptual)","children":[{"content":"<strong>User</strong> &#x2192; HTTP POST /chat &#x2192; <strong>ADK Agent (Cloud Run)</strong>","children":[{"content":"Agent uses <strong>Vertex AI (Gemini)</strong> for LLM.","children":[],"payload":{"tag":"li","lines":"443,444"}},{"content":"Agent uses <strong>MCP client (SSE)</strong> to call <strong>MCP Server (Cloud Run)</strong> with <strong>Bearer ID token</strong>.","children":[],"payload":{"tag":"li","lines":"444,445"}},{"content":"MCP server validates token (Cloud Run IAM) and runs <strong>get_exchange_rate</strong> (Frankfurter API).","children":[],"payload":{"tag":"li","lines":"445,446"}}],"payload":{"tag":"li","lines":"442,446"}},{"content":"<strong>IAM:</strong> Agent SA has <code>run.invoker</code> on MCP server and <code>aiplatform.user</code> on project.","children":[],"payload":{"tag":"li","lines":"446,447"}},{"content":"<strong>Transport:</strong> SSE to <code>/sse</code>; auth and IAM unchanged from Streamable HTTP.","children":[],"payload":{"tag":"li","lines":"447,448"}}],"payload":{"tag":"h2","lines":"440,441"}}],"payload":{"tag":"h1","lines":"8,9"}},{"colorFreezeLevel":2})</script>
</body>
</html>
